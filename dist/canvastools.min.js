/*!
 * CanvasTools v1.0.0 
 * (github)https://github.com/S-mohan/canvasTools
 * (url) https://smohan.net/lab/canvas-tools
 * (c) smohan <https://smohan.net>
 * license MIT
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("CanvasTools",[],e):"object"==typeof exports?exports.CanvasTools=e():t.CanvasTools=e()}(this,function(){return function(t){function e(o){if(n[o])return n[o].exports;var i=n[o]={i:o,l:!1,exports:{}};return t[o].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var n={};return e.m=t,e.c=n,e.i=function(t){return t},e.d=function(t,n,o){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:o})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=4)}([function(t,e){},function(t,e,n){"use strict";window.Element&&!Element.prototype.closest&&(Element.prototype.closest=function(t){var e,n=(this.document||this.ownerDocument).querySelectorAll(t),o=this;do{for(e=n.length;--e>=0&&n.item(e)!==o;);}while(e<0&&(o=o.parentElement));return o})},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o={rect:{panel:"stroke",name:"矩形工具"},ellipse:{panel:"stroke",name:"椭圆工具"},brush:{panel:"stroke",name:"画笔工具"},arrow:{panel:"stroke",name:"箭头工具"},mosaic:{panel:"mosaic",name:"马赛克工具"},font:{panel:"font",name:"文字工具"},rubber:{name:"橡皮擦"},undo:{name:"撤销操作"},save:{name:"保存"}},i=["#000000","#808080","#800000","#f7883a","#308430","#385ad3","#800080","#009999","#ffffff","#c0c0c0","#fb3838","#ffff00","#99cc00","#3894e4","#f31bf3","#16dcdc"],a=[12,14,16,18,20,22],r=[2,4,6],s=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=[];for(var n in o)if(function(e){return t&&!!~t.indexOf(e)}(n)){var i=o[n];e.push('<div class="canvas-tools-btn js-btn" data-panel="'+(i.panel||"")+'" data-value="'+n+'" data-action="" title="'+i.name+'">\n\t\t\t<a class="btn-toggle'+("save"===n?" js-canvas-save":"")+'"><i class="canvas-tools-icon__'+n+'"></i></a>\n\t\t\t</div>')}return e.join("")},l=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"#fb3838",e="";e+='<div class="colors">',e+='<span class="color-selected"><i class="js-color-selected" style="background:'+t+'"></i></span>',e+='<div class="color-list">';for(var n=[],o=[],a=0;a<16;a++){var r='<li class="js-color" style="background:'+i[a]+'" data-value="'+i[a]+'"></li>';a<8?n.push(r):o.push(r)}return e+="<ul>"+n.join("")+"</ul>",e+="<ul>"+o.join("")+"</ul>",e+="</div>",e+="</div>"},c=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,e='<div class="strokes">',n=!0,o=!1,i=void 0;try{for(var a,s=r[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var l=a.value,c=["stroke","js-stroke-width"];l===t&&c.push("active"),e+='<a class="'+c.join(" ")+'" data-value="'+l+'"><i style="width:'+(l+1)+"px;height:"+(l+1)+'px;"></i></a>'}}catch(t){o=!0,i=t}finally{try{!n&&s.return&&s.return()}finally{if(o)throw i}}return e+="</div>"},u=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:12,e='<select class="font-select js-font-size">',n=!0,o=!1,i=void 0;try{for(var r,s=a[Symbol.iterator]();!(n=(r=s.next()).done);n=!0){var l=r.value;e+='<option value="'+l+'" '+(l===t?"selected":"")+">"+l+"</option>"}}catch(t){o=!0,i=t}finally{try{!n&&s.return&&s.return()}finally{if(o)throw i}}return e+="</select>"};e.default={getButtons:s,getColorPanel:l,getStrokePanel:c,getFontPanel:u},t.exports=e.default},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=Array.prototype,a={id:/^#([\w-]+)$/,className:/^\.([\w-]+)$/,tagName:/^[\w-]+$/},r=function(t){return"[object Object]"===Object.prototype.toString.call(t)},s=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"*",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document;if("string"==typeof t){t=t.trim();var n=[];return a.id.test(t)?(n=document.getElementById(RegExp.$1),n=n?[n]:[]):n=a.className.test(t)?e.getElementsByClassName(RegExp.$1):a.tagName.test(t)?e.getElementsByTagName(t):e.querySelectorAll(t),i.slice.call(n)}return[]},l=function(t,e){if("object"===(void 0===t?"undefined":o(t))&&"function"==typeof e)if(Array.isArray(t))for(var n=0,i=t.length;n<i&&!1!==e.call(t[n],n,t[n]);n++);else if("length"in t&&"number"==typeof t.length)for(var a in t)if(!1===e.call(t[a],a,t[a]))break},c=function(t,e,n,o){var a=void 0,r=void 0;if("function"==typeof n)r=n;else{if("string"!=typeof n||"function"!=typeof o)return;a=n}a&&(r=function(e){for(var n=s(a,t),r=!1,l=0,c=n.length;l<c;l++){var u=n[l];if(u===e.target||u.contains(e.target)){r=u;break}}r&&o.apply(r,i.slice.call(arguments))}),t.addEventListener(e,r,!1)},u=function(t,e,n){return t.removeEventListener(e,n,!1)},f=function(t){return t.ownerDocument.defaultView.getComputedStyle(t,null)},h=function t(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=1,o=arguments.length;n<o;n++){var i=arguments[n];if(i&&Object.keys(i).length)for(var a in i)i.hasOwnProperty(a)&&(r(i[a])?e[a]=t(e[a],i[a]):e[a]=i[a])}return e},d=function(t,e,n,o){Array.isArray(t)||(t=[t]),l(t,function(t,i){return c(i,e,n,o)})},p=function(t,e,n){Array.isArray(t)||(t=[t]),l(t,function(t,o){return u(o,e,n)})},v=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"add",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";Array.isArray(t)||(t=[t]),l(t,function(t,o){return o.classList[e](n)})};e.$=s,e.each=l,e.bind=c,e.extend=h,e.unbind=u,e.getComputedStyles=f,e.classList=v,e.$on=d,e.$off=p},function(t,e,n){"use strict";function o(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function a(){var t=this,e=this.canvas,n=this.context,o=this.$el,i=this.state,a=(this.config,this.rect),f=this._handles,h=this.history,p=d.$(".js-btn",o),v=d.$(".js-panel__font",o)[0],y=d.$(".js-panel__stroke",o)[0],m=d.$(".js-color-selected",o),b=d.$(".js-color",o),x=d.$(".js-stroke-width",o),w=d.$(".js-font-size",o),k=d.$(".js-canvas-save",o)[0];f.btnEmit=function(e){var o=this;e.stopPropagation(),"font"===i.drawType&&c.call(t,e);var r=this.getAttribute("data-panel"),s=this.getAttribute("data-value");if(d.each(p,function(t,e){e!==o&&d.classList(e,"remove","active")}),~g.indexOf(s)&&(i.drawType=s),r){d.classList(this,"toggle","active");var l=/active/.test(this.className),u=l?"block":"none";"stroke"===r?(v.style.display="none",y.style.display=u):"font"===r&&(v.style.display=u,y.style.display="none")}"undo"===s&&h.length>1&&(h.pop(),n.putImageData(h[h.length-1],0,0,0,0,a.width,a.height))},f.toggleColor=function(t){var e=this.getAttribute("data-value");i.strokeColor=e,d.each(m,function(t,n){return n.style.background=e})},f.toggleStrokeWidth=function(t){i.strokeWidth=Number(this.getAttribute("data-value")),d.each(x,function(t,e){var n=Number(e.getAttribute("data-value")),o=n===i.strokeWidth?"add":"remove";d.classList(e,o,"active")})},f.toggleFontSize=function(t){i.fontSize=Number(this.value)};var $=void 0;f.onMouseDown=function(e){if(!1!=!!~g.indexOf(i.drawType)&&"font"!==i.drawType){switch($=C(e,a),i.lastImageData=n.getImageData(0,0,a.width,a.height),n.lineCap="round",n.lineJoin="round",n.shadowBlur=0,n.strokeStyle=i.strokeColor,n.lineWidth=i.strokeWidth,i.drawType){case"rect":r.call(t,e,$);break;case"ellipse":s.call(t,e,$);break;case"brush":default:l.call(t,e,$)}d.$on(document,"mousemove",f.onMouseMove),d.$on(document,"mouseup",f.onMouseUp)}},f.onMouseMove=function(e){if(!1!=!!~g.indexOf(i.drawType)&&"font"!==i.drawType)switch(i.drawType){case"rect":r.call(t,e,$);break;case"ellipse":s.call(t,e,$);break;case"brush":default:l.call(t,e,null)}},f.onMouseUp=function(e){d.$off(document,"mousemove",f.onMouseMove),d.$off(document,"mouseup",f.onMouseUp),~g.indexOf(i.drawType)&&"font"!==i.drawType&&u.call(t)},f.insertTextHelper=function(e){if(e.stopPropagation(),"font"===i.drawType){if(i.isEntry)return void c.call(t,e);T(e,i,a),i.isEntry=!0}},f.removeTextHelper=function(e){"font"!==i.drawType?S():e.target.closest("#canvas-tools-input")||c.call(t,e)},f.download=function(t){t.stopPropagation();var n=e.toDataURL("png");n=n.replace("image/png","image/octet-stream"),this.href=n,this.download="canvas_"+Date.now()+".png"},d.$on(p,"click",f.btnEmit),d.$on(b,"click",f.toggleColor),d.$on(x,"click",f.toggleStrokeWidth),d.$on(w,"change",f.toggleFontSize),d.$on(e,"mousedown",f.onMouseDown),d.$on(e,"click",f.insertTextHelper),d.$on(document,"click",f.removeTextHelper),d.$on(k,"click",f.download)}function r(t,e){var n=this.context,o=this.rect,i=this.state,a=C(t,o),r=a.x-e.x,s=a.y-e.y;n.clearRect(0,0,o.width,o.height),n.putImageData(i.lastImageData,0,0,0,0,o.width,o.height),n.save(),n.beginPath(),n.strokeRect(e.x,e.y,r,s),n.restore(),n.closePath()}function s(t,e){var n=this.context,o=this.rect,i=this.state,a=C(t,o),r=(a.x-e.x)/2*1,s=(a.y-e.y)/2*1,l=e.x/r+1,c=e.y/s+1;n.clearRect(0,0,o.width,o.height),n.putImageData(i.lastImageData,0,0,0,0,o.width,o.height),n.save(),n.beginPath(),n.scale(r,s),n.arc(l,c,1,0,2*Math.PI),n.restore(),n.closePath(),n.stroke()}function l(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this.context,o=this.rect;if(e)n.beginPath(),n.moveTo(e.x,e.y);else{var i=C(t,o);n.lineTo(i.x,i.y),n.stroke()}}function c(t){var e=document.getElementById("canvas-tools-input");if(!e)return void(this.state.isEntry=!1);var n=e.textContent.trim(),o=n.length;if(!n||!o)return this.state.isEntry=!1,void S();var i=d.getComputedStyles(e),a=this.state.fontSize||x,r=2*b,s=this.context,l=parseFloat(i.left)-this.rect.left+r-2,c=parseFloat(i.top)-this.rect.top+a,f=0,h=0;s.beginPath(),s.save(),s.fillStyle=this.state.strokeColor,s.font=this.state.fontSize+"px "+w;for(var p=0;p<o;p++){var v=n[p];f+=s.measureText(v).width,f>this.rect.width-l&&(s.fillText(n.substring(h,p),l,c),c+=a,f=0,h=p),p==o-1&&s.fillText(n.substring(h,p+1),l,c)}s.restore(),s.closePath(),this.state.isEntry=!1,S(),u.call(this)}function u(){this.history.push(this.context.getImageData(0,0,this.rect.width,this.rect.height))}Object.defineProperty(e,"__esModule",{value:!0});var f=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}();n(0),n(1);var h=n(3),d=o(h),p=n(2),v=o(p),g=["rect","ellipse","brush","arrow","mosaic","font","rubber"],y="#fb3838",m=2,b=2,x=12,w='"Helvetica Neue",Helvetica,Arial,"Hiragino Sans GB","Hiragino Sans GB W3","WenQuanYi Micro Hei",sans-serif',k=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:y,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:y,n=document.createElement("div");return n.className="canvas-tools__panel js-panel__stroke",n.innerHTML=v.getStrokePanel(t)+v.getColorPanel(e),n},$=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:x,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:y,n=document.createElement("div");return n.className="canvas-tools__panel js-panel__font",n.innerHTML=v.getFontPanel(t)+v.getColorPanel(e),n},j=function(){var t=document.getElementById("canvas-tools-input");return t||(t=document.createElement("div"),t.setAttribute("contenteditable","plaintext-only"),t.setAttribute("spellcheck","false"),t.setAttribute("id","canvas-tools-input"),t.className="canvas-tools-input",document.body.appendChild(t)),t.innerHTML="",t.style.cssText="display: block",t},T=function(t,e,n){var o=j(),i=e.fontSize||x,a=2*b+2,r=C(t,n),s=t.pageX,l=t.pageY,c=Math.floor(n.width-r.x)-a,u=Math.floor(n.height-r.y)-a;c<=i&&(s-=i+a-c,c=i),u<=i&&(l-=i+a-u,u=i),c>=n.width&&(c=n.width-r.x),u>=n.height&&(u=n.height-r.y);var f={"font-size":i+"px","line-height":i+"px","min-width":i+"px","min-height":i+"px","max-width":c+"px","max-height":u+"px","z-index":19900206,"font-family":w,display:"block",position:"fixed",top:l+"px",left:s+"px",color:e.strokeColor,padding:b+"px",overflow:"hidden"},h="";for(var d in f)h+=d+":"+f[d]+";";return o.style.cssText=h,o.focus(),o},S=function(){var t=document.getElementById("canvas-tools-input");t&&(t.innerHTML="",t.style.cssText="display: none")},C=function(t,e){var n=t.pageX-e.left,o=t.pageY-e.top;return n<=0&&(n=0),n>=e.width&&(n=e.width),o<=0&&(o=0),o>=e.height&&(o=e.height),{x:n,y:o}},E={container:document.body,buttons:["rect","ellipse","brush","font","undo","save"]},_=function(){function t(e,n){if(i(this,t),!e||"function"!=typeof e.getContext)throw new Error("invalid canvas object");this.canvas=e,this.context=e.getContext("2d"),this.config=d.extend({},E,n||{}),this.history=[],this.state=Object.create(null),this.rect=Object.create(null),this._handles=Object.create(null),this.state.strokeWidth=m,this.state.fontSize=x,this.state.strokeColor=y,this.state.drawType="brush",this.state.isEntry=!1,this.rect.width=e.width,this.rect.height=e.height,this.rect.top=e.offsetTop,this.rect.left=e.offsetLeft,this.state.lastImageData=this.context.getImageData(0,0,this.rect.width,this.rect.height),u.call(this),this.render()}return f(t,[{key:"render",value:function(){var t=this.config,e=this.state,n=document.createElement("div");n.className="canvas-tools",n.innerHTML=v.getButtons(t.buttons),t.container.appendChild(n),this.$el=n,this.$el.appendChild(k(e.strokeWidth,e.strokeColor)),this.$el.appendChild($(e.fontSize,e.strokeColor)),a.call(this)}},{key:"destory",value:function(){var t=this.canvas,e=this.$el,n=this._handles,o=d.$(".js-btn",e),i=d.$(".js-color",e),a=d.$(".js-stroke-width",e),r=d.$(".js-font-size",e),s=d.$(".js-canvas-save",e)[0],l=document.getElementById("canvas-tools-input");d.$off(o,"click",n.btnEmit),d.$off(i,"click",n.toggleColor),d.$off(a,"click",n.toggleStrokeWidth),d.$off(r,"change",n.toggleFontSize),d.$off(t,"mousedown",n.onMouseDown),d.$off(t,"click",n.insertTextHelper),d.$off(document,"click",n.removeTextHelper),d.$off(s,"click",n.download),l&&l.parentNoed.removeChild(l),this.canvas=null,this.context=null,this.history.length=0}}]),t}();e.default=_,t.exports=e.default}])});