{"version":3,"sources":["webpack:///webpack/universalModuleDefinition","webpack:///webpack/bootstrap 3d0f7d73a94331f1babe","webpack:///./src/scss/canvastools.scss","webpack:///./src/js/closet.js","webpack:///./src/js/template.js","webpack:///./src/js/utils.js","webpack:///./src/js/main.js"],"names":["window","Element","prototype","closest","s","matches","document","ownerDocument","querySelectorAll","i","el","length","item","parentElement","ButtonsMap","rect","panel","name","ellipse","brush","arrow","mosaic","font","rubber","undo","save","ColorList","FontSize","StrokeWidth","getButtons","buttons","html","useButton","indexOf","btn","key","push","join","getColorPanel","color","items1","items2","getStrokePanel","stroke","len","size","classes","getFontPanel","fontSize","selected","ArrayProto","Array","SelectorRegs","id","className","tagName","isObject","obj","isPlainObject","Object","toString","call","$","selector","context","trim","dom","test","getElementById","RegExp","$1","getElementsByClassName","getElementsByTagName","slice","each","object","callback","isArray","k","bind","element","eventType","sel","handler","e","nodes","matched","node","target","contains","apply","arguments","addEventListener","unbind","removeEventListener","getComputedStyles","defaultView","getComputedStyle","extend","out","keys","hasOwnProperty","$on","elements","index","$off","classList","type","STROKE_TYPES","STROKE_DEFAULT_COLOR","STROKE_DEFAULT_WIDTH","TEXT_HELPER_PADDING","TEXT_HELPER_ZINDEX","TEXT_HELPER_ID","TEXT_HELPER_FONT_SIZE","TEXT_FONT_FAMILY","buildStrokePanel","createElement","style","cssText","innerHTML","buildFontPanel","getTextHelper","$textHelper","setAttribute","body","appendChild","insertTextHelper","event","state","threshold","padding","pos","getPos","x","pageX","y","pageY","maxW","Math","floor","width","maxH","height","styleMap","display","position","top","left","strokeColor","overflow","focus","removeTextHelper","defaults","container","$saveLink","createElementNS","canUseSaveLink","__downloadFile","fileName","Date","now","canvas","fileUrl","toDataURL","replace","setTimeout","href","download","dispatchEvent","MouseEvent","navigator","msToBlob","msSaveBlob","console","log","__bindEvents","self","$el","config","_handles","history","$btns","$fontPanel","$strokePanel","$colorSelected","$colors","$strokeWidth","$fontSize","btnEmit","stopPropagation","drawType","__drawFont","getAttribute","value","$btn","isActive","visible","pop","putImageData","__toggleCanvasCursor","toggleColor","background","toggleStrokeWidth","strokeWidth","Number","method","toggleFontSize","_startPos","onMouseDown","lastImageData","getImageData","lineCap","lineJoin","shadowBlur","strokeStyle","lineWidth","__drawRect","__drawEllipse","__drawBrush","onMouseMove","onMouseUp","__pushHistory","isEntry","resize","_rect","getBoundingClientRect","offsetWidth","offsetHeight","start","clearRect","beginPath","strokeRect","restore","closePath","scaleX","scaleY","scale","arc","PI","moveTo","lineTo","content","textContent","parseFloat","lastSubStrIndex","fillStyle","char","measureText","fillText","substring","cursor","CanvasTools","options","getContext","Error","create","render","C","S","parentNoed","removeChild"],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD,O;ACVA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA,mDAA2C,cAAc;;AAEzD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAK;AACL;AACA;;AAEA;AACA;AACA;AACA,mCAA2B,0BAA0B,EAAE;AACvD,yCAAiC,eAAe;AAChD;AACA;AACA;;AAEA;AACA,8DAAsD,+DAA+D;;AAErH;AACA;;AAEA;AACA;;;;;;;AChEA,yC;;;;;;;;;ACAA;AACA;AACA,IAAIA,OAAOC,OAAP,IAAkB,CAACA,QAAQC,SAAR,CAAkBC,OAAzC,EAAkD;AAC9CF,YAAQC,SAAR,CAAkBC,OAAlB,GACI,UAASC,CAAT,EAAY;AACR,YAAIC,UAAU,CAAC,KAAKC,QAAL,IAAiB,KAAKC,aAAvB,EAAsCC,gBAAtC,CAAuDJ,CAAvD,CAAd;AAAA,YACIK,CADJ;AAAA,YAEIC,KAAK,IAFT;AAGA,WAAG;AACCD,gBAAIJ,QAAQM,MAAZ;AACA,mBAAO,EAAEF,CAAF,IAAO,CAAP,IAAYJ,QAAQO,IAAR,CAAaH,CAAb,MAAoBC,EAAvC,EAA2C,CAAE;AAChD,SAHD,QAGUD,IAAI,CAAL,KAAYC,KAAKA,GAAGG,aAApB,CAHT;AAIA,eAAOH,EAAP;AACH,KAVL;AAWH,C;;;;;;;;;;;;ACdD,IAAMI,aAAa;AAClBC,OAAM;AACLC,SAAO,QADF;AAELC,QAAM;AAFD,EADY;AAKlBC,UAAS;AACRF,SAAO,QADC;AAERC,QAAM;AAFE,EALS;AASlBE,QAAO;AACNH,SAAO,QADD;AAENC,QAAM;AAFA,EATW;AAalBG,QAAO;AACNJ,SAAO,QADD;AAENC,QAAM;AAFA,EAbW;AAiBlBI,SAAQ;AACPL,SAAO,QADA;AAEPC,QAAM;AAFC,EAjBU;AAqBlBK,OAAM;AACLN,SAAO,MADF;AAELC,QAAM;AAFD,EArBY;AAyBlBM,SAAQ;AACPN,QAAM;AADC,EAzBU;AA4BlBO,OAAM;AACLP,QAAM;AADD,EA5BY;AA+BlBQ,OAAM;AACLR,QAAM;AADD;;AAMP;AArCmB,CAAnB,CAsCA,IAAMS,YAAY,CAAC,SAAD,EAAY,SAAZ,EAAuB,SAAvB,EAAkC,SAAlC,EAA6C,SAA7C,EAAwD,SAAxD,EAAmE,SAAnE,EAA8E,SAA9E,EAAyF,SAAzF,EAAoG,SAApG,EAA+G,SAA/G,EAA0H,SAA1H,EAAqI,SAArI,EAAgJ,SAAhJ,EAA2J,SAA3J,EAAsK,SAAtK,CAAlB;;AAEA;AACA,IAAMC,WAAW,CAAC,EAAD,EAAK,EAAL,EAAS,EAAT,EAAa,EAAb,EAAiB,EAAjB,EAAqB,EAArB,CAAjB;;AAEA;AACA,IAAMC,cAAc,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAApB;;AAGA;;;;;AAKA,IAAMC,aAAa,SAAbA,UAAa,GAAkB;AAAA,KAAjBC,OAAiB,uEAAP,EAAO;;AACpC,KAAIC,OAAO,EAAX;AACA,KAAMC,YAAY,SAAZA,SAAY,MAAO;AACxB,SAAOF,WAAW,CAAC,CAAC,CAACA,QAAQG,OAAR,CAAgBC,GAAhB,CAArB;AACA,EAFD;AAGA,MAAK,IAAIC,GAAT,IAAgBrB,UAAhB,EAA4B;AAC3B,MAAIkB,UAAUG,GAAV,CAAJ,EAAoB;AACnB,OAAID,MAAMpB,WAAWqB,GAAX,CAAV;AACAJ,QAAKK,IAAL,wDAA8DF,IAAIlB,KAAJ,IAAa,EAA3E,uBAA8FmB,GAA9F,gCAA4HD,IAAIjB,IAAhI,qEACqDkB,GADrD;AAGA;AACD;AACD,QAAOJ,KAAKM,IAAL,CAAU,EAAV,CAAP;AACA,CAdD;;AAiBA;;;;;AAKA,IAAMC,gBAAgB,SAAhBA,aAAgB,GAAuB;AAAA,KAAtBC,KAAsB,uEAAd,SAAc;;AAC5C,KAAIR,OAAO,EAAX;AACAA,SAAQ,sBAAR;AACAA,0FAAuFQ,KAAvF;AACAR,SAAQ,0BAAR;;AAEA,KAAIS,SAAS,EAAb;AAAA,KACCC,SAAS,EADV;AAEA,MAAK,IAAIhC,IAAI,CAAb,EAAgBA,IAAI,EAApB,EAAwBA,GAAxB,EAA6B;AAC5B,MAAIG,mDAAiDc,UAAUjB,CAAV,CAAjD,sBAA8EiB,UAAUjB,CAAV,CAA9E,YAAJ;AACA,MAAIA,IAAI,CAAR,EAAW;AACV+B,UAAOJ,IAAP,CAAYxB,IAAZ;AACA,GAFD,MAEO;AACN6B,UAAOL,IAAP,CAAYxB,IAAZ;AACA;AACD;;AAEDmB,kBAAeS,OAAOH,IAAP,CAAY,EAAZ,CAAf;AACAN,kBAAeU,OAAOJ,IAAP,CAAY,EAAZ,CAAf;;AAEAN,SAAQ,QAAR;AACAA,SAAQ,QAAR;;AAEA,QAAOA,IAAP;AACA,CAxBD;;AA2BA;;;;;AAKA,IAAMW,iBAAiB,SAAjBA,cAAiB,GAAgB;AAAA,KAAfC,MAAe,uEAAN,CAAM;;AACtC,KAAIZ,OAAO,uBAAX;AACA,MAAK,IAAItB,IAAI,CAAR,EAAWmC,MAAMhB,YAAYjB,MAAlC,EAA0CF,IAAImC,GAA9C,EAAmDnC,GAAnD,EAAwD;AACvD,MAAIoC,OAAOjB,YAAYnB,CAAZ,CAAX;AACA,MAAIqC,UAAU,CAAC,QAAD,EAAW,iBAAX,CAAd;AACAD,WAASF,MAAT,IAAmBG,QAAQV,IAAR,CAAa,QAAb,CAAnB;AACAL,yBAAqBe,QAAQT,IAAR,CAAa,GAAb,CAArB,sBAAuDQ,IAAvD,2BAAgFA,OAAO,CAAvF,oBAAqGA,OAAO,CAA5G;AACA;AACDd,SAAQ,QAAR;AACA,QAAOA,IAAP;AACA,CAVD;;AAaA;;;;;AAKA,IAAMgB,eAAe,SAAfA,YAAe,GAAmB;AAAA,KAAlBC,QAAkB,uEAAP,EAAO;;AACvC,KAAIjB,OAAO,2CAAX;AACA,MAAK,IAAItB,IAAI,CAAR,EAAWmC,MAAMjB,SAAShB,MAA/B,EAAuCF,IAAImC,GAA3C,EAAgDnC,GAAhD,EAAqD;AACpD,MAAIoC,OAAOlB,SAASlB,CAAT,CAAX;AACA,MAAIwC,WAAW,CAAC,EAAEJ,SAASG,QAAX,CAAD,GAAwB,UAAxB,GAAqC,EAApD;AACAjB,8BAA0Bc,IAA1B,UAAmCI,QAAnC,SAA+CJ,IAA/C;AACA;AACDd,SAAQ,WAAR;AACA,QAAOA,IAAP;AACA,CATD;;kBAWe;AACdF,uBADc;AAEdS,6BAFc;AAGdI,+BAHc;AAIdK;AAJc,C;;;;;;;;;;;;;;;;ACvIf,IAAMG,aAAaC,MAAMjD,SAAzB;;AAEA,IAAMkD,eAAe;AACpBC,KAAI,aADgB;AAEpBC,YAAW,cAFS;AAGpBC,UAAS;AAHW,CAArB;;AAOA,IAAMC,WAAW,SAAXA,QAAW;AAAA,QAAOC,QAAQ,IAAR,IAAgB,QAAOA,GAAP,yCAAOA,GAAP,OAAe,QAAtC;AAAA,CAAjB;;AAGA,IAAMC,gBAAgB,SAAhBA,aAAgB;AAAA,QAAOC,OAAOzD,SAAP,CAAiB0D,QAAjB,CAA0BC,IAA1B,CAA+BJ,GAA/B,MAAwC,iBAA/C;AAAA,CAAtB;;AAIA;;;;;;AAMA,IAAMK,IAAI,SAAJA,CAAI,GAAwC;AAAA,KAAvCC,QAAuC,uEAA5B,GAA4B;AAAA,KAAvBC,OAAuB,uEAAb1D,QAAa;;AACjD,KAAI,OAAOyD,QAAP,KAAoB,QAAxB,EAAkC;AACjCA,aAAWA,SAASE,IAAT,EAAX;AACA,MAAIC,MAAM,EAAV;AACA,MAAId,aAAaC,EAAb,CAAgBc,IAAhB,CAAqBJ,QAArB,CAAJ,EAAoC;AACnCG,SAAM5D,SAAS8D,cAAT,CAAwBC,OAAOC,EAA/B,CAAN;AACAJ,SAAMA,MAAM,CAACA,GAAD,CAAN,GAAc,EAApB;AACA,GAHD,MAGO,IAAId,aAAaE,SAAb,CAAuBa,IAAvB,CAA4BJ,QAA5B,CAAJ,EAA2C;AACjDG,SAAMF,QAAQO,sBAAR,CAA+BF,OAAOC,EAAtC,CAAN;AACA,GAFM,MAEA,IAAIlB,aAAaG,OAAb,CAAqBY,IAArB,CAA0BJ,QAA1B,CAAJ,EAAyC;AAC/CG,SAAMF,QAAQQ,oBAAR,CAA6BT,QAA7B,CAAN;AACA,GAFM,MAEA;AACNG,SAAMF,QAAQxD,gBAAR,CAAyBuD,QAAzB,CAAN;AACA;AACD,SAAOb,WAAWuB,KAAX,CAAiBZ,IAAjB,CAAsBK,GAAtB,CAAP;AACA;AACD,QAAO,EAAP;AACA,CAjBD;;AAoBA;;;;;;AAMA,IAAMQ,OAAO,SAAPA,IAAO,CAACC,MAAD,EAASC,QAAT,EAAsB;AAClC,KAAI,QAAOD,MAAP,yCAAOA,MAAP,OAAkB,QAAlB,IAA8B,OAAOC,QAAP,KAAoB,UAAtD,EAAkE;AACjE,MAAIzB,MAAM0B,OAAN,CAAcF,MAAd,CAAJ,EAA2B;AAC1B,QAAK,IAAIlE,IAAI,CAAR,EAAWmC,MAAM+B,OAAOhE,MAA7B,EAAqCF,IAAImC,GAAzC,EAA8CnC,GAA9C,EAAmD;AAClD,QAAImE,SAASf,IAAT,CAAcc,OAAOlE,CAAP,CAAd,EAAyBA,CAAzB,EAA4BkE,OAAOlE,CAAP,CAA5B,MAA2C,KAA/C,EAAsD;AACrD;AACA;AACD;AACD,GAND,MAMO,IAAI,YAAYkE,MAAZ,IAAsB,OAAOA,OAAOhE,MAAd,KAAyB,QAAnD,EAA6D;AAAE;AACrE,QAAK,IAAImE,CAAT,IAAcH,MAAd,EAAsB;AACrB,QAAIC,SAASf,IAAT,CAAcc,OAAOG,CAAP,CAAd,EAAyBA,CAAzB,EAA4BH,OAAOG,CAAP,CAA5B,MAA2C,KAA/C,EAAsD;AACrD;AACA;AACD;AACD;AACD;AACD,CAhBD;;AAmBA;;;;;;;;AAQA,IAAMC,OAAO,SAAPA,IAAO,CAACC,OAAD,EAAUC,SAAV,EAAqBlB,QAArB,EAA+Ba,QAA/B,EAA4C;AACxD,KAAIM,YAAJ;AAAA,KAASC,gBAAT;AACA,KAAI,OAAOpB,QAAP,KAAoB,UAAxB,EAAoC;AACnCoB,YAAUpB,QAAV;AACA,EAFD,MAEO,IAAI,OAAOA,QAAP,KAAoB,QAApB,IAAgC,OAAOa,QAAP,KAAoB,UAAxD,EAAoE;AAC1EM,QAAMnB,QAAN;AACA,EAFM,MAEA;AACN;AACA;AACD,KAAImB,GAAJ,EAAS;AAAE;AACVC,YAAU,iBAASC,CAAT,EAAY;AACrB,OAAMC,QAAQvB,EAAEoB,GAAF,EAAOF,OAAP,CAAd;AACA,OAAIM,UAAU,KAAd;AACA,QAAK,IAAI7E,IAAI,CAAR,EAAWmC,MAAMyC,MAAM1E,MAA5B,EAAoCF,IAAImC,GAAxC,EAA6CnC,GAA7C,EAAkD;AACjD,QAAM8E,OAAOF,MAAM5E,CAAN,CAAb;AACA,QAAI8E,SAASH,EAAEI,MAAX,IAAqBD,KAAKE,QAAL,CAAcL,EAAEI,MAAhB,CAAzB,EAAkD;AACjDF,eAAUC,IAAV;AACA;AACA;AACD;AACD,OAAID,OAAJ,EAAa;AACZV,aAASc,KAAT,CAAeJ,OAAf,EAAwBpC,WAAWuB,KAAX,CAAiBZ,IAAjB,CAAsB8B,SAAtB,CAAxB;AACA;AACD,GAbD;AAcA;;AAEDX,SAAQY,gBAAR,CAAyBX,SAAzB,EAAoCE,OAApC,EAA6C,KAA7C;AACA,CA3BD;;AA8BA;;;;;;;AAOA,IAAMU,SAAS,SAATA,MAAS,CAACb,OAAD,EAAUC,SAAV,EAAqBL,QAArB;AAAA,QAAkCI,QAAQc,mBAAR,CAA4Bb,SAA5B,EAAuCL,QAAvC,EAAiD;;AAGlG;;;;;AAHiD,EAAlC;AAAA,CAAf,CAQA,IAAMmB,oBAAoB,SAApBA,iBAAoB;AAAA,QAAWf,QAAQzE,aAAR,CAAsByF,WAAtB,CAAkCC,gBAAlC,CAAmDjB,OAAnD,EAA4D;;AAGjG;;;;;AAHqC,EAAX;AAAA,CAA1B,CAQA,IAAMkB,SAAS,SAATA,MAAS,GAAmB;AAAA,KAAVC,GAAU,uEAAJ,EAAI;;AACjC,MAAK,IAAI1F,IAAI,CAAR,EAAWmC,MAAM+C,UAAUhF,MAAhC,EAAwCF,IAAImC,GAA5C,EAAiDnC,GAAjD,EAAsD;AACrD,MAAIgD,MAAMkC,UAAUlF,CAAV,CAAV;AACA,MAAI,CAACgD,GAAD,IAAQ,CAACE,OAAOyC,IAAP,CAAY3C,GAAZ,EAAiB9C,MAA9B,EACC;AACD,OAAK,IAAIwB,GAAT,IAAgBsB,GAAhB,EAAqB;AACpB,OAAIA,IAAI4C,cAAJ,CAAmBlE,GAAnB,CAAJ,EAA6B;AAC5B,QAAIuB,cAAcD,IAAItB,GAAJ,CAAd,CAAJ,EACCgE,IAAIhE,GAAJ,IAAW+D,OAAOC,IAAIhE,GAAJ,CAAP,EAAiBsB,IAAItB,GAAJ,CAAjB,CAAX,CADD,KAGCgE,IAAIhE,GAAJ,IAAWsB,IAAItB,GAAJ,CAAX;AACD;AACD;AACD;AACD,QAAOgE,GAAP;AACA,CAfD;;AAkBA,IAAMG,MAAM,SAANA,GAAM,CAACC,QAAD,EAAWtB,SAAX,EAAsBlB,QAAtB,EAAgCa,QAAhC,EAA6C;AACxD,KAAI,CAACzB,MAAM0B,OAAN,CAAc0B,QAAd,CAAL,EAA8B;AAC7BA,aAAW,CAACA,QAAD,CAAX;AACA;AACD7B,MAAK6B,QAAL,EAAe,UAACC,KAAD,EAAQxB,OAAR;AAAA,SAAoBD,KAAKC,OAAL,EAAcC,SAAd,EAAyBlB,QAAzB,EAAmCa,QAAnC,CAApB;AAAA,EAAf;AACA,CALD;;AAOA,IAAM6B,OAAO,SAAPA,IAAO,CAACF,QAAD,EAAWtB,SAAX,EAAsBL,QAAtB,EAAmC;AAC/C,KAAI,CAACzB,MAAM0B,OAAN,CAAc0B,QAAd,CAAL,EAA8B;AAC7BA,aAAW,CAACA,QAAD,CAAX;AACA;AACD7B,MAAK6B,QAAL,EAAe,UAACC,KAAD,EAAQxB,OAAR;AAAA,SAAoBa,OAAOb,OAAP,EAAgBC,SAAhB,EAA2BL,QAA3B,CAApB;AAAA,EAAf;AACA,CALD;;AAOA,IAAM8B,YAAY,SAAZA,SAAY,CAACH,QAAD,EAA0C;AAAA,KAA/BI,IAA+B,uEAAxB,KAAwB;AAAA,KAAjB7D,OAAiB,uEAAP,EAAO;;AAC3D,KAAI,CAACK,MAAM0B,OAAN,CAAc0B,QAAd,CAAL,EAA8B;AAC7BA,aAAW,CAACA,QAAD,CAAX;AACA;AACD7B,MAAK6B,QAAL,EAAe,UAACC,KAAD,EAAQxB,OAAR;AAAA,SAAoBA,QAAQ0B,SAAR,CAAkBC,IAAlB,EAAwB7D,OAAxB,CAApB;AAAA,EAAf;AACA,CALD;;kBAQe;AACdgB,KADc;AAEdY,WAFc;AAGdK,WAHc;AAIdmB,eAJc;AAKdL,eALc;AAMdE,qCANc;AAOdW,qBAPc;AAQdJ,SARc;AASdG;AATc,C;;;;;;;;;;;;;;;;ACxKf;;AACA;;AACA;;;;AACA;;;;;;;;AAEA;AACA,IAAMG,eAAe,CAAC,MAAD,EAAS,SAAT,EAAoB,OAApB,EAA6B,OAA7B,EAAsC,QAAtC,EAAgD,MAAhD,EAAwD,QAAxD,CAArB;;AAEA;AACA,IAAMC,uBAAuB,SAA7B;;AAEA;AACA,IAAMC,uBAAuB,CAA7B;;AAEA;AACA,IAAMC,sBAAsB,CAA5B;;AAEA;AACA,IAAMC,qBAAqB,IAA3B;;AAEA;AACA,IAAMC,iBAAiB,0BAAvB;;AAEA;AACA;AACA,IAAMC,wBAAwB,EAA9B;;AAEA;AACA,IAAMC,mBAAmB,4GAAzB;;AAGA;;;;;;AAMA,IAAMC,mBAAmB,SAAnBA,gBAAmB,GAAiE;AAAA,KAAhEzE,MAAgE,uEAAvDkE,oBAAuD;AAAA,KAAjCtE,KAAiC,uEAAzBsE,oBAAyB;;AACzF,KAAMnG,KAAKJ,SAAS+G,aAAT,CAAuB,KAAvB,CAAX;AACA3G,IAAG4C,SAAH,GAAe,sCAAf;AACA5C,IAAG4G,KAAH,CAASC,OAAT,IAAoB,gCAApB;AACA7G,IAAG8G,SAAH,GAAe,mBAAS9E,cAAT,CAAwBC,MAAxB,IAAkC,mBAASL,aAAT,CAAuBC,KAAvB,CAAjD;AACA,QAAO7B,EAAP;AACA,CAND;;AAQA;;;;;;AAMA,IAAM+G,iBAAiB,SAAjBA,cAAiB,GAAoE;AAAA,KAAnEzE,QAAmE,uEAAxDkE,qBAAwD;AAAA,KAAjC3E,KAAiC,uEAAzBsE,oBAAyB;;AAC1F,KAAMnG,KAAKJ,SAAS+G,aAAT,CAAuB,KAAvB,CAAX;AACA3G,IAAG4C,SAAH,GAAe,oCAAf;AACA5C,IAAG4G,KAAH,CAASC,OAAT,IAAoB,gCAApB;AACA7G,IAAG8G,SAAH,GAAe,mBAASzE,YAAT,CAAsBC,QAAtB,IAAkC,mBAASV,aAAT,CAAuBC,KAAvB,CAAjD;AACA,QAAO7B,EAAP;AACA,CAND;;AASA;;;;AAIA,IAAMgH,gBAAgB,SAAhBA,aAAgB,GAAM;AAC3B,KAAIC,cAAcrH,SAAS8D,cAAT,CAAwB6C,cAAxB,CAAlB;AACA,KAAI,CAACU,WAAL,EAAkB;AACjBA,gBAAcrH,SAAS+G,aAAT,CAAuB,KAAvB,CAAd;AACAM,cAAYC,YAAZ,CAAyB,iBAAzB,EAA4C,gBAA5C;AACAD,cAAYC,YAAZ,CAAyB,YAAzB,EAAuC,OAAvC;AACAD,cAAYC,YAAZ,CAAyB,IAAzB,EAA+BX,cAA/B;AACAU,cAAYrE,SAAZ,GAAwB2D,cAAxB;AACA3G,WAASuH,IAAT,CAAcC,WAAd,CAA0BH,WAA1B;AACA;AACDA,aAAYH,SAAZ,GAAwB,EAAxB;AACAG,aAAYL,KAAZ,CAAkBC,OAAlB,GAA4B,gBAA5B;AACA,QAAOI,WAAP;AACA,CAbD;;AAeA;;;;;;;AAOA,IAAMI,mBAAmB,SAAnBA,gBAAmB,CAACC,KAAD,EAAQC,KAAR,EAAelH,IAAf,EAAwB;AAChD,KAAM4G,cAAcD,eAApB;AAAA,KACCQ,YAAYD,MAAMjF,QAAN,IAAkBkE,qBAD/B;AAAA,KAECiB,UAAU,IAAIpB,mBAAJ,GAA0B,CAFrC;AAAA,KAGCqB,MAAMC,OAAOL,KAAP,EAAcjH,IAAd,CAHP;;AAKA,KAAIuH,IAAIN,MAAMO,KAAd;AAAA,KACCC,IAAIR,MAAMS,KADX;AAAA,KAECC,OAAOC,KAAKC,KAAL,CAAW7H,KAAK8H,KAAL,GAAaT,IAAIE,CAA5B,IAAiCH,OAFzC;AAAA,KAGCW,OAAOH,KAAKC,KAAL,CAAW7H,KAAKgI,MAAL,GAAcX,IAAII,CAA7B,IAAkCL,OAH1C;;AAKA,KAAIO,QAAQR,SAAZ,EAAuB;AACtBI,OAAMJ,YAAYC,OAAZ,GAAsBO,IAA5B;AACAA,SAAOR,SAAP;AACA;;AAED,KAAIY,QAAQZ,SAAZ,EAAuB;AACtBM,OAAMN,YAAYC,OAAZ,GAAsBW,IAA5B;AACAA,SAAOZ,SAAP;AACA;;AAED,KAAIQ,QAAQ3H,KAAK8H,KAAjB,EAAwB;AACvBH,SAAO3H,KAAK8H,KAAL,GAAaT,IAAIE,CAAxB;AACA;;AAED,KAAIQ,QAAQ/H,KAAKgI,MAAjB,EAAyB;AACxBD,SAAO/H,KAAKgI,MAAL,GAAcX,IAAII,CAAzB;AACA;;AAED,KAAMQ,WAAW;AAChB,eAAad,YAAY,IADT;AAEhB,iBAAeA,YAAY,IAFX;AAGhB,eAAaA,YAAY,IAHT;AAIhB,gBAAcA,YAAY,IAJV;AAKhB,eAAaQ,OAAO,IALJ;AAMhB,gBAAcI,OAAO,IANL;AAOhB,aAAW9B,kBAPK;AAQhB,iBAAeG,gBARC;AAShB8B,WAAS,OATO;AAUhBC,YAAU,UAVM;AAWhBC,OAAKX,IAAI,IAXO;AAYhBY,QAAMd,IAAI,IAZM;AAahB/F,SAAO0F,MAAMoB,WAbG;AAchBlB,WAASpB,sBAAsB,IAdf;AAehBuC,YAAU;AAfM,EAAjB;;AAkBA,KAAIhC,QAAQ,EAAZ;;AAEA,MAAK,IAAInF,GAAT,IAAgB6G,QAAhB,EAA0B;AACzB1B,WAAYnF,GAAZ,SAAmB6G,SAAS7G,GAAT,CAAnB;AACA;;AAEDwF,aAAYL,KAAZ,CAAkBC,OAAlB,GAA4BD,KAA5B;AACAK,aAAY4B,KAAZ;AACA,QAAO5B,WAAP;AACA,CAxDD;;AA0DA;;;;AAIA,IAAM6B,mBAAmB,SAAnBA,gBAAmB,GAAM;AAC9B,KAAI7B,cAAcrH,SAAS8D,cAAT,CAAwB6C,cAAxB,CAAlB;AACA,KAAI,CAACU,WAAL,EAAkB;AACjB;AACA;AACDA,aAAYH,SAAZ,GAAwB,EAAxB;AACAG,aAAYL,KAAZ,CAAkBC,OAAlB,GAA4B,eAA5B;AACA,CAPD;;AAUA;;;;;;AAMA,IAAMc,SAAS,SAATA,MAAS,CAACL,KAAD,EAAQjH,IAAR,EAAiB;AAC/B,KAAIuH,IAAIN,MAAMO,KAAN,GAAcxH,KAAKqI,IAA3B;AACA,KAAIZ,IAAIR,MAAMS,KAAN,GAAc1H,KAAKoI,GAA3B;AACA,KAAIb,KAAK,CAAT,EAAYA,IAAI,CAAJ;AACZ,KAAIA,KAAKvH,KAAK8H,KAAd,EAAqBP,IAAIvH,KAAK8H,KAAT;AACrB,KAAIL,KAAK,CAAT,EAAYA,IAAI,CAAJ;AACZ,KAAIA,KAAKzH,KAAKgI,MAAd,EAAsBP,IAAIzH,KAAKgI,MAAT;;AAEtB,QAAO;AACNT,MADM;AAENE;AAFM,EAAP;AAIA,CAZD;;AAeA;;;;AAIA,IAAMiB,WAAW;AAChB;AACAC,YAAWpJ,SAASuH,IAFJ;AAGhB;AACA/F,UAAS,CAAC,MAAD,EAAS,SAAT,EAAoB,OAApB,EAA6B,MAA7B,EAAqC,MAArC,EAA6C,MAA7C;;AAGV;AAPiB,CAAjB,CAQA,IAAM6H,YAAYrJ,SAASsJ,eAAT,CAAyB,8BAAzB,EAAyD;;AAE3E;AAFkB,CAAlB,CAGA,IAAMC,iBAAiB,cAAcF,SAArC;;AAEA;AACA,IAAMG,iBAAiB,SAAjBA,cAAiB,GAAW;AACjC,KAAMC,uBAAqBC,KAAKC,GAAL,EAArB,SAAN;AACA,KAAMC,SAAS,KAAKA,MAApB;;AAEA,KAAIL,cAAJ,EAAoB;AACnB,MAAIM,UAAUD,OAAOE,SAAP,CAAiB,KAAjB,CAAd;AACAD,YAAUA,QAAQE,OAAR,CAAgB,WAAhB,EAA6B,oBAA7B,CAAV;AACAC,aAAW,YAAM;AAChBX,aAAUY,IAAV,GAAiBJ,OAAjB;AACAR,aAAUa,QAAV,GAAqBT,QAArB;;AAEA;AACAJ,aAAUc,aAAV,CAAwB,IAAIC,UAAJ,CAAe,OAAf,CAAxB;AACA,GAND;AAOA;;AAED;AAZA,MAaK,IAAI,OAAOC,SAAP,KAAqB,WAArB,IAAoC,OAAOT,OAAOU,QAAd,KAA2B,UAA/D,IAA6ED,UAAUE,UAA3F,EAAuG;AAC3GF,aAAUE,UAAV,CAAqBX,OAAOU,QAAP,EAArB,EAAwCb,QAAxC;AACA;;AAED;AAJK,OAKA;AACJe,YAAQC,GAAR,CAAY,aAAZ;AACA;AACD,CAzBD;;AA4BA;AACA,SAASC,YAAT,GAAwB;AACvB,KAAMC,OAAO,IAAb;AADuB,KAGtBf,MAHsB,GAWnB,IAXmB,CAGtBA,MAHsB;AAAA,KAItBlG,OAJsB,GAWnB,IAXmB,CAItBA,OAJsB;AAAA,KAKtBkH,GALsB,GAWnB,IAXmB,CAKtBA,GALsB;AAAA,KAMtBjD,KANsB,GAWnB,IAXmB,CAMtBA,KANsB;AAAA,KAOtBkD,MAPsB,GAWnB,IAXmB,CAOtBA,MAPsB;AAAA,KAQtBpK,IARsB,GAWnB,IAXmB,CAQtBA,IARsB;AAAA,KAStBqK,QATsB,GAWnB,IAXmB,CAStBA,QATsB;AAAA,KAUtBC,OAVsB,GAWnB,IAXmB,CAUtBA,OAVsB;;;AAavB,KAAMC,QAAQ,gBAAMxH,CAAN,CAAQ,SAAR,EAAmBoH,GAAnB,CAAd;AAAA,KACCK,aAAa,gBAAMzH,CAAN,CAAQ,iBAAR,EAA2BoH,GAA3B,EAAgC,CAAhC,CADd;AAAA,KAECM,eAAe,gBAAM1H,CAAN,CAAQ,mBAAR,EAA6BoH,GAA7B,EAAkC,CAAlC,CAFhB;AAAA,KAGCO,iBAAiB,gBAAM3H,CAAN,CAAQ,oBAAR,EAA8BoH,GAA9B,CAHlB;AAAA,KAICQ,UAAU,gBAAM5H,CAAN,CAAQ,WAAR,EAAqBoH,GAArB,CAJX;AAAA,KAKCS,eAAe,gBAAM7H,CAAN,CAAQ,kBAAR,EAA4BoH,GAA5B,CALhB;AAAA,KAMCU,YAAY,gBAAM9H,CAAN,CAAQ,eAAR,EAAyBoH;;AAEtC;AAFa,EANb,CASAE,SAASS,OAAT,GAAmB,UAAS7D,KAAT,EAAgB;AAAA;;AAClCA,QAAM8D,eAAN;AACA,MAAI7D,MAAM8D,QAAN,KAAmB,MAAvB,EAA+B;AAC9BC,cAAWnI,IAAX,CAAgBoH,IAAhB,EAAsBjD,KAAtB;AACA;AACD,MAAMhH,QAAQ,KAAKiL,YAAL,CAAkB,YAAlB,CAAd;AACA,MAAMC,QAAQ,KAAKD,YAAL,CAAkB,YAAlB,CAAd;AACA,kBAAMvH,IAAN,CAAW4G,KAAX,EAAkB,UAAC9E,KAAD,EAAQ2F,IAAR,EAAiB;AAClC,OAAIA,cAAJ,EAAmB;AAClB,oBAAMzF,SAAN,CAAgByF,IAAhB,EAAsB,QAAtB,EAAgC,QAAhC;AACA;AACD,GAJD;AAKA,MAAI,CAAC,CAAC,CAACvF,aAAa3E,OAAb,CAAqBiK,KAArB,CAAP,EAAoC;AACnCjE,SAAM8D,QAAN,GAAiBG,KAAjB;AACA;AACD,MAAIlL,KAAJ,EAAW;AACV,mBAAM0F,SAAN,CAAgB,IAAhB,EAAsB,QAAtB,EAAgC,QAAhC;AACA,OAAM0F,WAAW,SAASjI,IAAT,CAAc,KAAKb,SAAnB,CAAjB;AACA,OAAM+I,UAAUD,WAAW,OAAX,GAAqB,MAArC;AACA,OAAIpL,UAAU,QAAd,EAAwB;AACvBuK,eAAWjE,KAAX,CAAiB2B,OAAjB,GAA2B,MAA3B;AACAuC,iBAAalE,KAAb,CAAmB2B,OAAnB,GAA6BoD,OAA7B;AACA,IAHD,MAGO,IAAIrL,UAAU,MAAd,EAAsB;AAC5BuK,eAAWjE,KAAX,CAAiB2B,OAAjB,GAA2BoD,OAA3B;AACAb,iBAAalE,KAAb,CAAmB2B,OAAnB,GAA6B,MAA7B;AACA;AACD,GAXD,MAWO;AACN;AACA;AACA;;AAED,MAAIiD,UAAU,MAAd,EAAsB;AACrBpC,kBAAejG,IAAf,CAAoBoH,IAApB;AACA;AACA;;AAED;AACA;AACA,MAAIiB,UAAU,MAAV,IAAoBb,QAAQ1K,MAAR,GAAiB,CAAzC,EAA4C;AAC3C0K,WAAQiB,GAAR;AACAtI,WAAQuI,YAAR,CAAqBlB,QAAQA,QAAQ1K,MAAR,GAAiB,CAAzB,CAArB,EAAkD,CAAlD,EAAqD,CAArD,EAAwD,CAAxD,EAA2D,CAA3D,EAA8DI,KAAK8H,KAAnE,EAA0E9H,KAAKgI,MAA/E;AACA;;AAEDyD,uBAAqB3I,IAArB,CAA0BoH,IAA1B;AACA,EA5CD;;AA8CAG,UAASqB,WAAT,GAAuB,UAASzE,KAAT,EAAgB;AACtC,MAAMzF,QAAQ,KAAK0J,YAAL,CAAkB,YAAlB,CAAd;AACAhE,QAAMoB,WAAN,GAAoB9G,KAApB;AACA,kBAAMmC,IAAN,CAAW+G,cAAX,EAA2B,UAACjF,KAAD,EAAQ5F,IAAR;AAAA,UAAiBA,KAAK0G,KAAL,CAAWoF,UAAX,GAAwBnK,KAAzC;AAAA,GAA3B;AACA,EAJD;;AAMA6I,UAASuB,iBAAT,GAA6B,UAAS3E,KAAT,EAAgB;AAC5CC,QAAM2E,WAAN,GAAoBC,OAAO,KAAKZ,YAAL,CAAkB,YAAlB,CAAP,CAApB;AACA,kBAAMvH,IAAN,CAAWiH,YAAX,EAAyB,UAACnF,KAAD,EAAQ5F,IAAR,EAAiB;AACzC,OAAMsL,QAAQW,OAAOjM,KAAKqL,YAAL,CAAkB,YAAlB,CAAP,CAAd;AACA,OAAMa,SAASZ,UAAUjE,MAAM2E,WAAhB,GAA8B,KAA9B,GAAsC,QAArD;AACA,mBAAMlG,SAAN,CAAgB9F,IAAhB,EAAsBkM,MAAtB,EAA8B,QAA9B;AACA,GAJD;AAKA,EAPD;;AASA1B,UAAS2B,cAAT,GAA0B,UAAS/E,KAAT,EAAgB;AACzCC,QAAMjF,QAAN,GAAiB6J,OAAO,KAAKX,KAAZ,CAAjB;AACA,EAFD;;AAIA;AACA,KAAIc,kBAAJ;;AAEA5B,UAAS6B,WAAT,GAAuB,UAASjF,KAAT,EAAgB;AACtC,MAAI,CAAC,CAAC,CAACpB,aAAa3E,OAAb,CAAqBgG,MAAM8D,QAA3B,CAAH,KAA4C,KAA5C,IAAqD9D,MAAM8D,QAAN,KAAmB,MAA5E,EAAoF;AACnF;AACA;AACDiB,cAAY3E,OAAOL,KAAP,EAAcjH;;AAE1B;AAFY,GAAZ,CAGAkH,MAAMiF,aAAN,GAAsBlJ,QAAQmJ,YAAR,CAAqB,CAArB,EAAwB,CAAxB,EAA2BpM,KAAK8H,KAAhC,EAAuC9H,KAAKgI;;AAElE;AAFsB,GAAtB,CAGA/E,QAAQoJ,OAAR,GAAkB,OAAlB;AACApJ,UAAQqJ,QAAR,GAAmB,OAAnB;AACArJ,UAAQsJ,UAAR,GAAqB,CAArB;AACAtJ,UAAQuJ,WAAR,GAAsBtF,MAAMoB,WAA5B;AACArF,UAAQwJ,SAAR,GAAoBvF,MAAM2E,WAA1B;AACA,UAAQ3E,MAAM8D,QAAd;AACC,QAAK,MAAL;AACC0B,eAAW5J,IAAX,CAAgBoH,IAAhB,EAAsBjD,KAAtB,EAA6BgF,SAA7B;AACA;AACD,QAAK,SAAL;AACCU,kBAAc7J,IAAd,CAAmBoH,IAAnB,EAAyBjD,KAAzB,EAAgCgF,SAAhC;AACA;AACD,QAAK,OAAL;AACA;AACCW,gBAAY9J,IAAZ,CAAiBoH,IAAjB,EAAuBjD,KAAvB,EAA8BgF,SAA9B;AACA;AAVF;;AAaA,kBAAM1G,GAAN,CAAUhG,QAAV,EAAoB,WAApB,EAAiC8K,SAASwC,WAA1C;AACA,kBAAMtH,GAAN,CAAUhG,QAAV,EAAoB,SAApB,EAA+B8K,SAASyC,SAAxC;AACA,EA9BD;;AAgCAzC,UAASwC,WAAT,GAAuB,UAAS5F,KAAT,EAAgB;AACtC,MAAI,CAAC,CAAC,CAACpB,aAAa3E,OAAb,CAAqBgG,MAAM8D,QAA3B,CAAH,KAA4C,KAA5C,IAAqD9D,MAAM8D,QAAN,KAAmB,MAA5E,EAAoF;AACnF;AACA;AACD,UAAQ9D,MAAM8D,QAAd;AACC,QAAK,MAAL;AACC0B,eAAW5J,IAAX,CAAgBoH,IAAhB,EAAsBjD,KAAtB,EAA6BgF,SAA7B;AACA;AACD,QAAK,SAAL;AACCU,kBAAc7J,IAAd,CAAmBoH,IAAnB,EAAyBjD,KAAzB,EAAgCgF,SAAhC;AACA;AACD,QAAK,OAAL;AACA;AACCW,gBAAY9J,IAAZ,CAAiBoH,IAAjB,EAAuBjD,KAAvB,EAA8B,IAA9B;AACA;AAVF;AAYA,EAhBD;;AAkBAoD,UAASyC,SAAT,GAAqB,UAAS7F,KAAT,EAAgB;AACpC,kBAAMvB,IAAN,CAAWnG,QAAX,EAAqB,WAArB,EAAkC8K,SAASwC,WAA3C;AACA,kBAAMnH,IAAN,CAAWnG,QAAX,EAAqB,SAArB,EAAgC8K,SAASyC,SAAzC;AACA,MAAI,CAAC,CAAC,CAACjH,aAAa3E,OAAb,CAAqBgG,MAAM8D,QAA3B,CAAH,IAA2C9D,MAAM8D,QAAN,KAAmB,MAAlE,EAA0E;AACzE+B,iBAAcjK,IAAd,CAAmBoH,IAAnB;AACA;AACD,EAND;;AAQAG,UAASrD,gBAAT,GAA4B,UAASC,KAAT,EAAgB;AAC3CA,QAAM8D,eAAN;AACA,MAAI7D,MAAM8D,QAAN,KAAmB,MAAvB,EAA+B;AAC9B;AACA;AACD,MAAI9D,MAAM8F,OAAV,EAAmB;AAClB/B,cAAWnI,IAAX,CAAgBoH,IAAhB,EAAsBjD,KAAtB;AACA;AACA;AACDD,mBAAiBC,KAAjB,EAAwBC,KAAxB,EAA+BlH,IAA/B;AACAkH,QAAM8F,OAAN,GAAgB,IAAhB;AACA,EAXD;;AAaA3C,UAAS5B,gBAAT,GAA4B,UAASxB,KAAT,EAAgB;AAC3C,MAAIC,MAAM8D,QAAN,KAAmB,MAAvB,EAA+B;AAC9BvC;AACA,GAFD,MAEO,IAAI,CAACxB,MAAMxC,MAAN,CAAarF,OAAb,CAAqB,qBAArB,CAAL,EAAkD;AACxD6L,cAAWnI,IAAX,CAAgBoH,IAAhB,EAAsBjD,KAAtB;AACA;AACD,EAND;;AAQAoD,UAAS4C,MAAT,GAAkB,UAAShG,KAAT,EAAgB;AACjC,MAAMiG,QAAQ/D,OAAOgE,qBAAP,EAAd;AACAnN,OAAK8H,KAAL,GAAaqB,OAAOrB,KAApB;AACA9H,OAAKgI,MAAL,GAAcmB,OAAOnB,MAArB;AACAhI,OAAKoN,WAAL,GAAmBjE,OAAOiE,WAA1B;AACApN,OAAKqN,YAAL,GAAoBlE,OAAOkE,YAA3B;AACArN,OAAKoI,GAAL,GAAW8E,MAAM9E,GAAjB;AACApI,OAAKqI,IAAL,GAAY6E,MAAM7E,IAAlB;AACAnB,QAAM8D,QAAN,KAAmB,MAAnB,IAA6B9D,MAAM8F,OAAnC,IAA8C/B,WAAWnI,IAAX,CAAgBoH,IAAhB,EAAsBjD,KAAtB,CAA9C;AACA,EATD;;AAWA;AACA,iBAAM1B,GAAN,CAAUgF,KAAV,EAAiB,OAAjB,EAA0BF,SAASS;;AAEnC;AAFA,GAGA,gBAAMvF,GAAN,CAAUoF,OAAV,EAAmB,OAAnB,EAA4BN,SAASqB;;AAErC;AAFA,GAGA,gBAAMnG,GAAN,CAAUqF,YAAV,EAAwB,OAAxB,EAAiCP,SAASuB;;AAE1C;AAFA,GAGA,gBAAMrG,GAAN,CAAUsF,SAAV,EAAqB,QAArB,EAA+BR,SAAS2B;;AAExC;AAFA,GAGA,gBAAMzG,GAAN,CAAU4D,MAAV,EAAkB,WAAlB,EAA+BkB,SAAS6B;;AAExC;AAFA,GAGA,gBAAM3G,GAAN,CAAU4D,MAAV,EAAkB,OAAlB,EAA2BkB,SAASrD;;AAEpC;AAFA,GAGA,gBAAMzB,GAAN,CAAUhG,QAAV,EAAoB,OAApB,EAA6B8K,SAAS5B;;AAEtC;AAFA,GAGAxJ,OAAO4F,gBAAP,CAAwB,QAAxB,EAAkCwF,SAAS4C,MAA3C;AACA;;AAED;;;;;;AAMA,SAASP,UAAT,CAAoBzF,KAApB,EAA2BqG,KAA3B,EAAkC;AAAA,KAEhCrK,OAFgC,GAK7B,IAL6B,CAEhCA,OAFgC;AAAA,KAGhCjD,IAHgC,GAK7B,IAL6B,CAGhCA,IAHgC;AAAA,KAIhCkH,KAJgC,GAK7B,IAL6B,CAIhCA,KAJgC;;AAMjC,KAAMG,MAAMC,OAAOL,KAAP,EAAcjH,IAAd,CAAZ;AACA,KAAI8H,QAAQT,IAAIE,CAAJ,GAAQ+F,MAAM/F,CAA1B;AACA,KAAIS,SAASX,IAAII,CAAJ,GAAQ6F,MAAM7F,CAA3B;AACAxE,SAAQsK,SAAR,CAAkB,CAAlB,EAAqB,CAArB,EAAwBvN,KAAK8H,KAA7B,EAAoC9H,KAAKgI,MAAzC;AACA/E,SAAQuI,YAAR,CAAqBtE,MAAMiF,aAA3B,EAA0C,CAA1C,EAA6C,CAA7C,EAAgD,CAAhD,EAAmD,CAAnD,EAAsDnM,KAAK8H,KAA3D,EAAkE9H,KAAKgI,MAAvE;AACA/E,SAAQvC,IAAR;AACAuC,SAAQuK,SAAR;AACAvK,SAAQwK,UAAR,CAAmBH,MAAM/F,CAAzB,EAA4B+F,MAAM7F,CAAlC,EAAqCK,KAArC,EAA4CE,MAA5C;AACA/E,SAAQyK,OAAR;AACAzK,SAAQ0K,SAAR;AACA;;AAGD;;;;;;AAMA,SAAShB,aAAT,CAAuB1F,KAAvB,EAA8BqG,KAA9B,EAAqC;AAAA,KAEnCrK,OAFmC,GAKhC,IALgC,CAEnCA,OAFmC;AAAA,KAGnCjD,IAHmC,GAKhC,IALgC,CAGnCA,IAHmC;AAAA,KAInCkH,KAJmC,GAKhC,IALgC,CAInCA,KAJmC;;AAMpC,KAAMG,MAAMC,OAAOL,KAAP,EAAcjH,IAAd,CAAZ;AACA,KAAI4N,SAAS,KAAK,CAACvG,IAAIE,CAAJ,GAAQ+F,MAAM/F,CAAf,IAAoB,CAAzB,CAAb;AACA,KAAIsG,SAAS,KAAK,CAACxG,IAAII,CAAJ,GAAQ6F,MAAM7F,CAAf,IAAoB,CAAzB,CAAb;AACA,KAAIF,IAAK+F,MAAM/F,CAAN,GAAUqG,MAAX,GAAqB,CAA7B;AACA,KAAInG,IAAK6F,MAAM7F,CAAN,GAAUoG,MAAX,GAAqB,CAA7B;AACA5K,SAAQsK,SAAR,CAAkB,CAAlB,EAAqB,CAArB,EAAwBvN,KAAK8H,KAA7B,EAAoC9H,KAAKgI,MAAzC;AACA/E,SAAQuI,YAAR,CAAqBtE,MAAMiF,aAA3B,EAA0C,CAA1C,EAA6C,CAA7C,EAAgD,CAAhD,EAAmD,CAAnD,EAAsDnM,KAAK8H,KAA3D,EAAkE9H,KAAKgI,MAAvE;AACA/E,SAAQvC,IAAR;AACAuC,SAAQuK,SAAR;AACAvK,SAAQ6K,KAAR,CAAcF,MAAd,EAAsBC,MAAtB;AACA5K,SAAQ8K,GAAR,CAAYxG,CAAZ,EAAeE,CAAf,EAAkB,CAAlB,EAAqB,CAArB,EAAwB,IAAIG,KAAKoG,EAAjC;AACA/K,SAAQyK,OAAR;AACAzK,SAAQ0K,SAAR;AACA1K,SAAQrB,MAAR;AACA;;AAED;;;;;;AAMA,SAASgL,WAAT,CAAqB3F,KAArB,EAA0C;AAAA,KAAdqG,KAAc,uEAAN,IAAM;AAAA,KAExCrK,OAFwC,GAIrC,IAJqC,CAExCA,OAFwC;AAAA,KAGxCjD,IAHwC,GAIrC,IAJqC,CAGxCA,IAHwC;;AAKzC,KAAIsN,KAAJ,EAAW;AACVrK,UAAQuK,SAAR;AACAvK,UAAQgL,MAAR,CAAeX,MAAM/F,CAArB,EAAwB+F,MAAM7F,CAA9B;AACA,EAHD,MAGO;AACN,MAAMJ,MAAMC,OAAOL,KAAP,EAAcjH,IAAd,CAAZ;AACAiD,UAAQiL,MAAR,CAAe7G,IAAIE,CAAnB,EAAsBF,IAAII,CAA1B;AACAxE,UAAQrB,MAAR;AACA;AACD;;AAGD;;;;;AAKA,SAASqJ,UAAT,CAAoBhE,KAApB,EAA2B;AAC1B,KAAML,cAAcrH,SAAS8D,cAAT,CAAwB6C,cAAxB,CAApB;AACA,KAAI,CAACU,WAAL,EAAkB;AACjB,OAAKM,KAAL,CAAW8F,OAAX,GAAqB,KAArB;AACA;AACA;AACD,KAAMmB,UAAUvH,YAAYwH,WAAZ,CAAwBlL,IAAxB,EAAhB;AACA,KAAMtD,SAASuO,QAAQvO,MAAvB;AACA,KAAI,CAACuO,OAAD,IAAY,CAACvO,MAAjB,EAAyB;AACxB,OAAKsH,KAAL,CAAW8F,OAAX,GAAqB,KAArB;AACAvE;AACA;AACA;AACD,KAAMlC,QAAQ,gBAAMvB,iBAAN,CAAwB4B,WAAxB,CAAd;AAAA,KACCO,YAAY,KAAKD,KAAL,CAAWjF,QAAX,IAAuBkE,qBADpC;AAAA,KAECiB,UAAU,IAAIpB,mBAFf;AAAA,KAGC/C,UAAU,KAAKA,OAHhB;;AAKA,KAAIsE,IAAI8G,WAAW9H,MAAM8B,IAAjB,IAAyB,KAAKrI,IAAL,CAAUqI,IAAnC,GAA0CjB,OAA1C,GAAoD,CAA5D;AAAA,KACCK,IAAI4G,WAAW9H,MAAM6B,GAAjB,IAAwB,KAAKpI,IAAL,CAAUoI,GAAlC,GAAwCjB,SAD7C;AAAA,KAECsF,YAAY,CAFb;AAAA,KAGC6B,kBAAkB,CAHnB;;AAKArL,SAAQuK,SAAR;AACAvK,SAAQvC,IAAR;AACAuC,SAAQsL,SAAR,GAAoB,KAAKrH,KAAL,CAAWoB,WAA/B;AACArF,SAAQ1C,IAAR,GAAkB,KAAK2G,KAAL,CAAWjF,QAA7B,WAA2CmE,gBAA3C;;AAEA,MAAK,IAAI1G,IAAI,CAAb,EAAgBA,IAAIE,MAApB,EAA4BF,GAA5B,EAAiC;AAChC,MAAI8O,OAAOL,QAAQzO,CAAR,CAAX;;AAEA;AACA+M,eAAaxJ,QAAQwL,WAAR,CAAoBD,IAApB,EAA0B1G,KAAvC;AACA,MAAI2E,YAAY,KAAKzM,IAAL,CAAU8H,KAAV,GAAkBP,CAAlC,EAAqC;AACpCtE,WAAQyL,QAAR,CAAiBP,QAAQQ,SAAR,CAAkBL,eAAlB,EAAmC5O,CAAnC,CAAjB,EAAwD6H,CAAxD,EAA2DE,CAA3D;AACAA,QAAKN,SAAL;AACAsF,eAAY,CAAZ;AACA6B,qBAAkB5O,CAAlB;AACA;AACD,MAAIA,KAAKE,SAAS,CAAlB,EAAqB;AACpBqD,WAAQyL,QAAR,CAAiBP,QAAQQ,SAAR,CAAkBL,eAAlB,EAAmC5O,IAAI,CAAvC,CAAjB,EAA4D6H,CAA5D,EAA+DE,CAA/D;AACA;AACD;AACDxE,SAAQyK,OAAR;AACAzK,SAAQ0K,SAAR;AACA,MAAKzG,KAAL,CAAW8F,OAAX,GAAqB,KAArB;AACAvE;AACAsE,eAAcjK,IAAd,CAAmB,IAAnB;AACA;;AAGD;;;;AAIA,SAAS2I,oBAAT,GAAgC;AAC/B,KAAMtC,SAAS,KAAKA,MAApB;AACA,KAAIyF,eAAJ;AACA,SAAQ,KAAK1H,KAAL,CAAW8D,QAAnB;AACC,OAAK,OAAL;AACC4D,YAAS,OAAT;AACA;AACD,OAAK,MAAL;AACCA,YAAS,MAAT;AACA;AACD,OAAK,MAAL;AACA,OAAK,SAAL;AACCA,YAAS,WAAT;AACA;AACD;AACCA,YAAS,SAAT;AAZF;AAcA,KAAIA,MAAJ,EAAY;AACXzF,SAAO5G,SAAP,GAAmB4G,OAAO5G,SAAP,CAAiB+G,OAAjB,CAAyB,sBAAzB,EAAiD,EAAjD,EAAqDpG,IAArD,2BAAiF0L,MAAjF,CAAnB;AACA;AACD;;AAGD;;;;AAIA,SAAS7B,aAAT,GAAyB;AACxB,MAAKzC,OAAL,CAAajJ,IAAb,CAAkB,KAAK4B,OAAL,CAAamJ,YAAb,CAA0B,CAA1B,EAA6B,CAA7B,EAAgC,KAAKpM,IAAL,CAAU8H,KAA1C,EAAiD,KAAK9H,IAAL,CAAUgI,MAA3D,CAAlB;AACA;;AAED;;;;;IAIM6G,W;;AAEL;;;;;;AAMA,sBAAY1F,MAAZ,EAAoB2F,OAApB,EAA6B;AAAA;;AAC5B,MAAI,CAAC3F,MAAD,IAAW,OAAOA,OAAO4F,UAAd,KAA6B,UAA5C,EAAwD;AACvD,SAAM,IAAIC,KAAJ,CAAU,uBAAV,CAAN;AACA;AACD,OAAK7F,MAAL,GAAcA,MAAd;AACA,OAAKlG,OAAL,GAAekG,OAAO4F,UAAP,CAAkB,IAAlB,CAAf;AACA,OAAK3E,MAAL,GAAc,gBAAMjF,MAAN,CAAa,EAAb,EAAiBuD,QAAjB,EAA2BoG,WAAW,EAAtC,CAAd;;AAEA,OAAKxE,OAAL,GAAe,EAAf;AACA,OAAKpD,KAAL,GAAatE,OAAOqM,MAAP,CAAc,IAAd,CAAb;AACA,OAAKjP,IAAL,GAAY4C,OAAOqM,MAAP,CAAc,IAAd,CAAZ;AACA,OAAK5E,QAAL,GAAgBzH,OAAOqM,MAAP,CAAc,IAAd,CAAhB;;AAEA,OAAK/H,KAAL,CAAW2E,WAAX,GAAyB9F,oBAAzB;AACA,OAAKmB,KAAL,CAAWjF,QAAX,GAAsBkE,qBAAtB;AACA,OAAKe,KAAL,CAAWoB,WAAX,GAAyBxC,oBAAzB;AACA,OAAKoB,KAAL,CAAW8D,QAAX,GAAsB,OAAtB;AACA,OAAK9D,KAAL,CAAW8F,OAAX,GAAqB,KAArB;;AAEA,OAAKhN,IAAL,CAAU8H,KAAV,GAAkBqB,OAAOrB,KAAzB;AACA,OAAK9H,IAAL,CAAUgI,MAAV,GAAmBmB,OAAOnB,MAA1B;;AAEA,OAAKhI,IAAL,CAAUoN,WAAV,GAAwBjE,OAAOiE,WAA/B;AACA,OAAKpN,IAAL,CAAUqN,YAAV,GAAyBlE,OAAOkE,YAAhC;;AAEA,MAAMrN,OAAOmJ,OAAOgE,qBAAP,EAAb;AACA,OAAKnN,IAAL,CAAUoI,GAAV,GAAgBpI,KAAKoI,GAArB;AACA,OAAKpI,IAAL,CAAUqI,IAAV,GAAiBrI,KAAKqI,IAAtB;;AAEA;AACA,OAAKnB,KAAL,CAAWiF,aAAX,GAA2B,KAAKlJ,OAAL,CAAamJ,YAAb,CAA0B,CAA1B,EAA6B,CAA7B,EAAgC,KAAKpM,IAAL,CAAU8H,KAA1C,EAAiD,KAAK9H,IAAL,CAAUgI;;AAEtF;AAF2B,GAA3B,CAGA+E,cAAcjK,IAAd,CAAmB,IAAnB;;AAEA2I,uBAAqB3I,IAArB,CAA0B,IAA1B;;AAEA,OAAKoM,MAAL;AACA;;AAED;;;;;;;;2BAIS;AACR,OAAMC,IAAI,KAAK/E,MAAf;AACA,OAAMgF,IAAI,KAAKlI,KAAf;AACA,OAAIvH,KAAKJ,SAAS+G,aAAT,CAAuB,KAAvB,CAAT;AACA3G,MAAG4C,SAAH,GAAe,cAAf;AACA5C,MAAG8G,SAAH,GAAe,mBAAS3F,UAAT,CAAoBqO,EAAEpO,OAAtB,CAAf;AACAoO,KAAExG,SAAF,CAAY5B,WAAZ,CAAwBpH,EAAxB;;AAEA,QAAKwK,GAAL,GAAWxK,EAAX;AACA,QAAKwK,GAAL,CAASpD,WAAT,CAAqBV,iBAAiB+I,EAAEvD,WAAnB,EAAgCuD,EAAE9G,WAAlC,CAArB;AACA,QAAK6B,GAAL,CAASpD,WAAT,CAAqBL,eAAe0I,EAAEnN,QAAjB,EAA2BmN,EAAE9G,WAA7B,CAArB;AACA2B,gBAAanH,IAAb,CAAkB,IAAlB;AACA;;;4BAES,CAET;;AAED;;;;;;;4BAIU;AAAA,OAERqG,MAFQ,GAKL,IALK,CAERA,MAFQ;AAAA,OAGRgB,GAHQ,GAKL,IALK,CAGRA,GAHQ;AAAA,OAIRE,QAJQ,GAKL,IALK,CAIRA,QAJQ;;;AAOT,OAAME,QAAQ,gBAAMxH,CAAN,CAAQ,SAAR,EAAmBoH,GAAnB,CAAd;AAAA,OACCQ,UAAU,gBAAM5H,CAAN,CAAQ,WAAR,EAAqBoH,GAArB,CADX;AAAA,OAECS,eAAe,gBAAM7H,CAAN,CAAQ,kBAAR,EAA4BoH,GAA5B,CAFhB;AAAA,OAGCU,YAAY,gBAAM9H,CAAN,CAAQ,eAAR,EAAyBoH,GAAzB,CAHb;AAAA,OAICvD,cAAcrH,SAAS8D,cAAT,CAAwB6C,cAAxB,CAJf;;AAMA,mBAAMR,IAAN,CAAW6E,KAAX,EAAkB,OAAlB,EAA2BF,SAASS,OAApC;AACA,mBAAMpF,IAAN,CAAWiF,OAAX,EAAoB,OAApB,EAA6BN,SAASqB,WAAtC;AACA,mBAAMhG,IAAN,CAAWkF,YAAX,EAAyB,OAAzB,EAAkCP,SAASuB,iBAA3C;AACA,mBAAMlG,IAAN,CAAWmF,SAAX,EAAsB,QAAtB,EAAgCR,SAAS2B,cAAzC;AACA,mBAAMtG,IAAN,CAAWyD,MAAX,EAAmB,WAAnB,EAAgCkB,SAAS6B,WAAzC;AACA,mBAAMxG,IAAN,CAAWyD,MAAX,EAAmB,OAAnB,EAA4BkB,SAASrD,gBAArC;AACA,mBAAMtB,IAAN,CAAWnG,QAAX,EAAqB,OAArB,EAA8B8K,SAAS5B,gBAAvC;AACAxJ,UAAO8F,mBAAP,CAA2B,QAA3B,EAAqCsF,SAAS4C,MAA9C;AACArG,kBAAeA,YAAYyI,UAAZ,CAAuBC,WAAvB,CAAmC1I,WAAnC,CAAf;AACA,QAAKuC,MAAL,GAAc,IAAd;AACA,QAAKlG,OAAL,GAAe,IAAf;AACA,QAAKqH,OAAL,CAAa1K,MAAb,GAAsB,CAAtB;AACA,QAAKwK,MAAL,CAAYzB,SAAZ,CAAsB2G,WAAtB,CAAkC,KAAKnF,GAAvC;AACA;;;;;;kBAIa0E,W","file":"canvastools.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"CanvasTools\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"CanvasTools\"] = factory();\n\telse\n\t\troot[\"CanvasTools\"] = factory();\n})(this, function() {\nreturn \n\n\n// WEBPACK FOOTER //\n// webpack/universalModuleDefinition"," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// identity function for calling harmony imports with the correct context\n \t__webpack_require__.i = function(value) { return value; };\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 4);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 3d0f7d73a94331f1babe","// removed by extract-text-webpack-plugin\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/scss/canvastools.scss\n// module id = 0\n// module chunks = 0","//Element.closet Polyfill\r\n//https://developer.mozilla.org/en-US/docs/Web/API/Element/closest\r\nif (window.Element && !Element.prototype.closest) {\r\n    Element.prototype.closest =\r\n        function(s) {\r\n            var matches = (this.document || this.ownerDocument).querySelectorAll(s),\r\n                i,\r\n                el = this;\r\n            do {\r\n                i = matches.length;\r\n                while (--i >= 0 && matches.item(i) !== el) {};\r\n            } while ((i < 0) && (el = el.parentElement));\r\n            return el;\r\n        };\r\n}\n\n\n// WEBPACK FOOTER //\n// ./src/js/closet.js","const ButtonsMap = {\r\n\trect: {\r\n\t\tpanel: 'stroke',\r\n\t\tname: '矩形工具'\r\n\t},\r\n\tellipse: {\r\n\t\tpanel: 'stroke',\r\n\t\tname: '椭圆工具'\r\n\t},\r\n\tbrush: {\r\n\t\tpanel: 'stroke',\r\n\t\tname: '画笔工具'\r\n\t},\r\n\tarrow: {\r\n\t\tpanel: 'stroke',\r\n\t\tname: '箭头工具'\r\n\t},\r\n\tmosaic: {\r\n\t\tpanel: 'mosaic',\r\n\t\tname: '马赛克工具'\r\n\t},\r\n\tfont: {\r\n\t\tpanel: 'font',\r\n\t\tname: '文字工具'\r\n\t},\r\n\trubber: {\r\n\t\tname: '橡皮擦'\r\n\t},\r\n\tundo: {\r\n\t\tname: '撤销操作'\r\n\t},\r\n\tsave: {\r\n\t\tname: '保存'\r\n\t}\r\n}\r\n\r\n\r\n//可用颜色\r\nconst ColorList = ['#000000', '#808080', '#800000', '#f7883a', '#308430', '#385ad3', '#800080', '#009999', '#ffffff', '#c0c0c0', '#fb3838', '#ffff00', '#99cc00', '#3894e4', '#f31bf3', '#16dcdc']\r\n\r\n//可选择字号，Chrome不支持小于12号的字体\r\nconst FontSize = [12, 14, 16, 18, 20, 22]\r\n\r\n//画笔大小\r\nconst StrokeWidth = [2, 4, 6]\r\n\r\n\r\n/**\r\n * 获取buttons模版\r\n * @param  {Array}  buttons [可用按钮]\r\n * @return {String} \r\n */\r\nconst getButtons = (buttons = []) => {\r\n\tlet html = []\r\n\tconst useButton = btn => {\r\n\t\treturn buttons && !!~buttons.indexOf(btn)\r\n\t}\r\n\tfor (let key in ButtonsMap) {\r\n\t\tif (useButton(key)) {\r\n\t\t\tlet btn = ButtonsMap[key]\r\n\t\t\thtml.push(`<div class=\"canvas-tools-btn js-btn\" data-panel=\"${btn.panel || ''}\" data-value=\"${key}\" data-action=\"\" title=\"${btn.name}\">\r\n\t\t\t<a class=\"btn-toggle\"><i class=\"canvas-tools-icon__${key}\"></i></a>\r\n\t\t\t</div>`)\r\n\t\t}\r\n\t}\r\n\treturn html.join('')\r\n}\r\n\r\n\r\n/**\r\n * 获取颜色面板\r\n * @param  {String} color [当前选中色]\r\n * @return {String}\r\n */\r\nconst getColorPanel = (color = '#fb3838') => {\r\n\tlet html = ''\r\n\thtml += '<div class=\"colors\">'\r\n\thtml += `<span class=\"color-selected\"><i class=\"js-color-selected\" style=\"background:${color}\"></i></span>`\r\n\thtml += '<div class=\"color-list\">'\r\n\r\n\tlet items1 = [],\r\n\t\titems2 = []\r\n\tfor (let i = 0; i < 16; i++) {\r\n\t\tlet item = `<li class=\"js-color\" style=\"background:${ColorList[i]}\" data-value=\"${ColorList[i]}\"></li>`\r\n\t\tif (i < 8) {\r\n\t\t\titems1.push(item)\r\n\t\t} else {\r\n\t\t\titems2.push(item)\r\n\t\t}\r\n\t}\r\n\r\n\thtml += `<ul>${items1.join('')}</ul>`\r\n\thtml += `<ul>${items2.join('')}</ul>`\r\n\r\n\thtml += '</div>'\r\n\thtml += '</div>'\r\n\r\n\treturn html\r\n}\r\n\r\n\r\n/**\r\n * 获取画笔大小面板\r\n * @param  {Number} stroke [当前画笔大小]\r\n * @return {String}  \r\n */\r\nconst getStrokePanel = (stroke = 2) => {\r\n\tlet html = '<div class=\"strokes\">'\r\n\tfor (let i = 0, len = StrokeWidth.length; i < len; i++) {\r\n\t\tlet size = StrokeWidth[i]\r\n\t\tlet classes = ['stroke', 'js-stroke-width']\r\n\t\tsize === stroke && classes.push('active')\r\n\t\thtml += `<a class=\"${classes.join(' ')}\" data-value=\"${size}\"><i style=\"width:${size + 1}px;height:${size + 1}px;\"></i></a>`\r\n\t}\r\n\thtml += '</div>'\r\n\treturn html\r\n}\r\n\r\n\r\n/**\r\n * 获取字号选择器\r\n * @param  {Number} fontSize [默认字号]\r\n * @return {String} \r\n */\r\nconst getFontPanel = (fontSize = 12) => {\r\n\tlet html = '<select class=\"font-select js-font-size\">'\r\n\tfor (let i = 0, len = FontSize.length; i < len; i++) {\r\n\t\tlet size = FontSize[i]\r\n\t\tlet selected = !!(size === fontSize) ? 'selected' : ''\r\n\t\thtml += `<option value=\"${size}\" ${selected}>${size}</option>`\r\n\t}\r\n\thtml += '</select>'\r\n\treturn html\r\n}\r\n\r\nexport default {\r\n\tgetButtons,\r\n\tgetColorPanel,\r\n\tgetStrokePanel,\r\n\tgetFontPanel,\r\n}\n\n\n// WEBPACK FOOTER //\n// ./src/js/template.js","const ArrayProto = Array.prototype\r\n\r\nconst SelectorRegs = {\r\n\tid: /^#([\\w-]+)$/,\r\n\tclassName: /^\\.([\\w-]+)$/,\r\n\ttagName: /^[\\w-]+$/\r\n}\r\n\r\n\r\nconst isObject = obj => obj !== null && typeof obj === 'object'\r\n\r\n\r\nconst isPlainObject = obj => Object.prototype.toString.call(obj) === '[object Object]'\r\n\r\n\r\n\r\n/**\r\n * 获取元素对象集合\r\n * @param  {String} selector [选择器]\r\n * @param  {HTMLElement} context  [上下文对象]\r\n * @return {Array}          [元素节点集合]\r\n */\r\nconst $ = (selector = '*', context = document) => {\r\n\tif (typeof selector === \"string\") {\r\n\t\tselector = selector.trim()\r\n\t\tlet dom = [];\r\n\t\tif (SelectorRegs.id.test(selector)) {\r\n\t\t\tdom = document.getElementById(RegExp.$1)\r\n\t\t\tdom = dom ? [dom] : []\r\n\t\t} else if (SelectorRegs.className.test(selector)) {\r\n\t\t\tdom = context.getElementsByClassName(RegExp.$1)\r\n\t\t} else if (SelectorRegs.tagName.test(selector)) {\r\n\t\t\tdom = context.getElementsByTagName(selector)\r\n\t\t} else {\r\n\t\t\tdom = context.querySelectorAll(selector)\r\n\t\t}\r\n\t\treturn ArrayProto.slice.call(dom)\r\n\t}\r\n\treturn []\r\n}\r\n\r\n\r\n/**\r\n * 对象遍历\r\n * @param  {Object | Array}   object   [对象源]\r\n * @param  {Function} callback [回调]\r\n * @return  \r\n */\r\nconst each = (object, callback) => {\r\n\tif (typeof object === \"object\" && typeof callback === \"function\") {\r\n\t\tif (Array.isArray(object)) {\r\n\t\t\tfor (let i = 0, len = object.length; i < len; i++) {\r\n\t\t\t\tif (callback.call(object[i], i, object[i]) === false) {\r\n\t\t\t\t\tbreak\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if ('length' in object && typeof object.length === \"number\") { //这地方不太严谨，谨慎使用\r\n\t\t\tfor (let k in object) {\r\n\t\t\t\tif (callback.call(object[k], k, object[k]) === false) {\r\n\t\t\t\t\tbreak\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\n\r\n/**\r\n * 事件绑定，支持代理\r\n * @param  {HTMLElement}   element   [DOM元素]\r\n * @param  {String}   eventType [事件类型]\r\n * @param  {String}   selector  [选择器]\r\n * @param  {Function} callback  [回调]\r\n * @return \r\n */\r\nconst bind = (element, eventType, selector, callback) => {\r\n\tlet sel, handler;\r\n\tif (typeof selector === \"function\") {\r\n\t\thandler = selector\r\n\t} else if (typeof selector === \"string\" && typeof callback === \"function\") {\r\n\t\tsel = selector\r\n\t} else {\r\n\t\treturn\r\n\t}\r\n\tif (sel) { //事件代理\r\n\t\thandler = function(e) {\r\n\t\t\tconst nodes = $(sel, element)\r\n\t\t\tlet matched = false\r\n\t\t\tfor (let i = 0, len = nodes.length; i < len; i++) {\r\n\t\t\t\tconst node = nodes[i]\r\n\t\t\t\tif (node === e.target || node.contains(e.target)) {\r\n\t\t\t\t\tmatched = node\r\n\t\t\t\t\tbreak\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (matched) {\r\n\t\t\t\tcallback.apply(matched, ArrayProto.slice.call(arguments))\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\telement.addEventListener(eventType, handler, false)\r\n}\r\n\r\n\r\n/**\r\n * 事件解绑\r\n * @param  {HTMLElement}   element   [DOM元素]\r\n * @param  {String}   eventType [事件类型]\r\n * @param  {Function} callback  [回调]\r\n * @return \r\n */\r\nconst unbind = (element, eventType, callback) => element.removeEventListener(eventType, callback, false)\r\n\r\n\r\n/**\r\n * 获取指定元素样式\r\n * @param  {HTMLElement} element\r\n * @return {Object}  \r\n */\r\nconst getComputedStyles = element => element.ownerDocument.defaultView.getComputedStyle(element, null)\r\n\r\n\r\n/**\r\n * 对象深度拷贝\r\n * @param  {Object} out\r\n * @return {Object}\r\n */\r\nconst extend = function(out = {}) {\r\n\tfor (let i = 1, len = arguments.length; i < len; i++) {\r\n\t\tlet obj = arguments[i]\r\n\t\tif (!obj || !Object.keys(obj).length)\r\n\t\t\tcontinue\r\n\t\tfor (let key in obj) {\r\n\t\t\tif (obj.hasOwnProperty(key)) {\r\n\t\t\t\tif (isPlainObject(obj[key]))\r\n\t\t\t\t\tout[key] = extend(out[key], obj[key])\r\n\t\t\t\telse\r\n\t\t\t\t\tout[key] = obj[key]\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn out\r\n}\r\n\r\n\r\nconst $on = (elements, eventType, selector, callback) => {\r\n\tif (!Array.isArray(elements)) {\r\n\t\telements = [elements]\r\n\t}\r\n\teach(elements, (index, element) => bind(element, eventType, selector, callback))\r\n}\r\n\r\nconst $off = (elements, eventType, callback) => {\r\n\tif (!Array.isArray(elements)) {\r\n\t\telements = [elements]\r\n\t}\r\n\teach(elements, (index, element) => unbind(element, eventType, callback))\r\n}\r\n\r\nconst classList = (elements, type = 'add', classes = '') => {\r\n\tif (!Array.isArray(elements)) {\r\n\t\telements = [elements]\r\n\t}\r\n\teach(elements, (index, element) => element.classList[type](classes))\r\n}\r\n\r\n\r\nexport default {\r\n\t$,\r\n\teach,\r\n\tbind,\r\n\textend,\r\n\tunbind,\r\n\tgetComputedStyles,\r\n\tclassList,\r\n\t$on,\r\n\t$off,\r\n}\n\n\n// WEBPACK FOOTER //\n// ./src/js/utils.js","import '../scss/canvastools.scss'\r\nimport './closet'\r\nimport utils from './utils'\r\nimport Template from './template'\r\n\r\n//stroke类型操作\r\nconst STROKE_TYPES = ['rect', 'ellipse', 'brush', 'arrow', 'mosaic', 'font', 'rubber']\r\n\r\n//默认颜色\r\nconst STROKE_DEFAULT_COLOR = '#fb3838'\r\n\r\n//默认画笔大小\r\nconst STROKE_DEFAULT_WIDTH = 2\r\n\r\n//辅助输入框padding值\r\nconst TEXT_HELPER_PADDING = 2\r\n\r\n//辅助输入框层级\r\nconst TEXT_HELPER_ZINDEX = 1990\r\n\r\n//辅助输入框ID\r\nconst TEXT_HELPER_ID = 'canvas-tools_text_helper'\r\n\r\n//输入框默认字体大小\r\n//以设置的字体大小为准，改值仅做辅助值\r\nconst TEXT_HELPER_FONT_SIZE = 12\r\n\r\n//字体\r\nconst TEXT_FONT_FAMILY = '\"Helvetica Neue\",Helvetica,Arial,\"Hiragino Sans GB\",\"Hiragino Sans GB W3\",\"WenQuanYi Micro Hei\",sans-serif'\r\n\r\n\r\n/**\r\n * 创建画笔+颜色容器\r\n * @param  {Number} stroke [默认画笔]\r\n * @param  {String} color  [默认颜色]\r\n * @return {HTMLElement}   \r\n */\r\nconst buildStrokePanel = (stroke = STROKE_DEFAULT_COLOR, color = STROKE_DEFAULT_COLOR) => {\r\n\tconst el = document.createElement('div')\r\n\tel.className = 'canvas-tools__panel js-panel__stroke'\r\n\tel.style.cssText += 'white-space: nowrap!important;'\r\n\tel.innerHTML = Template.getStrokePanel(stroke) + Template.getColorPanel(color)\r\n\treturn el\r\n}\r\n\r\n/**\r\n * 创建字号+颜色容器\r\n * @param  {Number} fontSize [默认字号]\r\n * @param  {String} color  [默认颜色]\r\n * @return {HTMLElement}   \r\n */\r\nconst buildFontPanel = (fontSize = TEXT_HELPER_FONT_SIZE, color = STROKE_DEFAULT_COLOR) => {\r\n\tconst el = document.createElement('div')\r\n\tel.className = 'canvas-tools__panel js-panel__font'\r\n\tel.style.cssText += 'white-space: nowrap!important;'\r\n\tel.innerHTML = Template.getFontPanel(fontSize) + Template.getColorPanel(color)\r\n\treturn el\r\n}\r\n\r\n\r\n/**\r\n * 创建辅助文本输入框\r\n * @return {HTMLElement}\r\n */\r\nconst getTextHelper = () => {\r\n\tlet $textHelper = document.getElementById(TEXT_HELPER_ID)\r\n\tif (!$textHelper) {\r\n\t\t$textHelper = document.createElement('div')\r\n\t\t$textHelper.setAttribute('contenteditable', 'plaintext-only')\r\n\t\t$textHelper.setAttribute('spellcheck', 'false')\r\n\t\t$textHelper.setAttribute('id', TEXT_HELPER_ID)\r\n\t\t$textHelper.className = TEXT_HELPER_ID\r\n\t\tdocument.body.appendChild($textHelper)\r\n\t}\r\n\t$textHelper.innerHTML = ''\r\n\t$textHelper.style.cssText = 'display: block';\r\n\treturn $textHelper\r\n}\r\n\r\n/**\r\n * 初始化辅助文本输入框样式\r\n * @param  {MouseEvent} event [鼠标事件]\r\n * @param  {Object} state [instance state]\r\n * @param  {Object} rect  [instance rect]\r\n * @return {HTMLElement}   \r\n */\r\nconst insertTextHelper = (event, state, rect) => {\r\n\tconst $textHelper = getTextHelper(),\r\n\t\tthreshold = state.fontSize || TEXT_HELPER_FONT_SIZE,\r\n\t\tpadding = 2 * TEXT_HELPER_PADDING + 2,\r\n\t\tpos = getPos(event, rect)\r\n\r\n\tlet x = event.pageX,\r\n\t\ty = event.pageY,\r\n\t\tmaxW = Math.floor(rect.width - pos.x) - padding,\r\n\t\tmaxH = Math.floor(rect.height - pos.y) - padding\r\n\r\n\tif (maxW <= threshold) {\r\n\t\tx -= (threshold + padding - maxW)\r\n\t\tmaxW = threshold\r\n\t}\r\n\r\n\tif (maxH <= threshold) {\r\n\t\ty -= (threshold + padding - maxH)\r\n\t\tmaxH = threshold\r\n\t}\r\n\r\n\tif (maxW >= rect.width) {\r\n\t\tmaxW = rect.width - pos.x\r\n\t}\r\n\r\n\tif (maxH >= rect.height) {\r\n\t\tmaxH = rect.height - pos.y\r\n\t}\r\n\r\n\tconst styleMap = {\r\n\t\t'font-size': threshold + 'px',\r\n\t\t'line-height': threshold + 'px',\r\n\t\t'min-width': threshold + 'px',\r\n\t\t'min-height': threshold + 'px',\r\n\t\t'max-width': maxW + 'px',\r\n\t\t'max-height': maxH + 'px',\r\n\t\t'z-index': TEXT_HELPER_ZINDEX,\r\n\t\t'font-family': TEXT_FONT_FAMILY,\r\n\t\tdisplay: 'block',\r\n\t\tposition: 'absolute',\r\n\t\ttop: y + 'px',\r\n\t\tleft: x + 'px',\r\n\t\tcolor: state.strokeColor,\r\n\t\tpadding: TEXT_HELPER_PADDING + 'px',\r\n\t\toverflow: 'hidden',\r\n\t}\r\n\r\n\tlet style = ''\r\n\r\n\tfor (let key in styleMap) {\r\n\t\tstyle += `${key}:${styleMap[key]};`\r\n\t}\r\n\r\n\t$textHelper.style.cssText = style\r\n\t$textHelper.focus()\r\n\treturn $textHelper\r\n}\r\n\r\n/**\r\n * 移除辅助文本输入框\r\n * @return \r\n */\r\nconst removeTextHelper = () => {\r\n\tlet $textHelper = document.getElementById(TEXT_HELPER_ID)\r\n\tif (!$textHelper) {\r\n\t\treturn\r\n\t}\r\n\t$textHelper.innerHTML = ''\r\n\t$textHelper.style.cssText = 'display: none';\r\n}\r\n\r\n\r\n/**\r\n * 获取鼠标在Canvas上的位置\r\n * @param  {Element Event} event [鼠标事件]\r\n * @param  {Object} rect  [Canvas rect]\r\n * @return {Object} \r\n */\r\nconst getPos = (event, rect) => {\r\n\tlet x = event.pageX - rect.left\r\n\tlet y = event.pageY - rect.top\r\n\tif (x <= 0) x = 0\r\n\tif (x >= rect.width) x = rect.width\r\n\tif (y <= 0) y = 0\r\n\tif (y >= rect.height) y = rect.height\r\n\r\n\treturn {\r\n\t\tx,\r\n\t\ty\r\n\t}\r\n}\r\n\r\n\r\n/**\r\n * 默认配置\r\n * @type {Object}\r\n */\r\nconst defaults = {\r\n\t//工具条父级对象容器\r\n\tcontainer: document.body,\r\n\t//显示按钮\r\n\tbuttons: ['rect', 'ellipse', 'brush', 'font', 'undo', 'save']\r\n}\r\n\r\n//创建一个下载链接\r\nconst $saveLink = document.createElementNS('http://www.w3.org/1999/xhtml', 'a')\r\n\r\n//是否支持原生下载\r\nconst canUseSaveLink = 'download' in $saveLink\r\n\r\n//下载文件\r\nconst __downloadFile = function() {\r\n\tconst fileName = `canvas_${Date.now()}.png`\r\n\tconst canvas = this.canvas\r\n\r\n\tif (canUseSaveLink) {\r\n\t\tlet fileUrl = canvas.toDataURL('png')\r\n\t\tfileUrl = fileUrl.replace('image/png', 'image/octet-stream')\r\n\t\tsetTimeout(() => {\r\n\t\t\t$saveLink.href = fileUrl\r\n\t\t\t$saveLink.download = fileName\r\n\r\n\t\t\t//触发click事件\r\n\t\t\t$saveLink.dispatchEvent(new MouseEvent('click'))\r\n\t\t})\r\n\t}\r\n\r\n\t//for ie 10+ \r\n\telse if (typeof navigator !== \"undefined\" && typeof canvas.msToBlob === 'function' && navigator.msSaveBlob) {\r\n\t\tnavigator.msSaveBlob(canvas.msToBlob(), fileName)\r\n\t}\r\n\r\n\t// other \r\n\telse {\r\n\t\tconsole.log('您的浏览器不支持该操作')\r\n\t}\r\n}\r\n\r\n\r\n//相关事件绑定\r\nfunction __bindEvents() {\r\n\tconst self = this\r\n\tconst {\r\n\t\tcanvas,\r\n\t\tcontext,\r\n\t\t$el,\r\n\t\tstate,\r\n\t\tconfig,\r\n\t\trect,\r\n\t\t_handles,\r\n\t\thistory\r\n\t} = this\r\n\r\n\tconst $btns = utils.$('.js-btn', $el),\r\n\t\t$fontPanel = utils.$('.js-panel__font', $el)[0],\r\n\t\t$strokePanel = utils.$('.js-panel__stroke', $el)[0],\r\n\t\t$colorSelected = utils.$('.js-color-selected', $el),\r\n\t\t$colors = utils.$('.js-color', $el),\r\n\t\t$strokeWidth = utils.$('.js-stroke-width', $el),\r\n\t\t$fontSize = utils.$('.js-font-size', $el)\r\n\r\n\t//按钮事件\r\n\t_handles.btnEmit = function(event) {\r\n\t\tevent.stopPropagation()\r\n\t\tif (state.drawType === 'font') {\r\n\t\t\t__drawFont.call(self, event)\r\n\t\t}\r\n\t\tconst panel = this.getAttribute('data-panel')\r\n\t\tconst value = this.getAttribute('data-value')\r\n\t\tutils.each($btns, (index, $btn) => {\r\n\t\t\tif ($btn !== this) {\r\n\t\t\t\tutils.classList($btn, 'remove', 'active')\r\n\t\t\t}\r\n\t\t})\r\n\t\tif (!!~STROKE_TYPES.indexOf(value)) {\r\n\t\t\tstate.drawType = value\r\n\t\t}\r\n\t\tif (panel) {\r\n\t\t\tutils.classList(this, 'toggle', 'active')\r\n\t\t\tconst isActive = /active/.test(this.className)\r\n\t\t\tconst visible = isActive ? 'block' : 'none'\r\n\t\t\tif (panel === 'stroke') {\r\n\t\t\t\t$fontPanel.style.display = 'none'\r\n\t\t\t\t$strokePanel.style.display = visible\r\n\t\t\t} else if (panel === 'font') {\r\n\t\t\t\t$fontPanel.style.display = visible\r\n\t\t\t\t$strokePanel.style.display = 'none'\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t//$fontPanel.style.display = 'none'\r\n\t\t\t//$strokePanel.style.display = 'none'\r\n\t\t}\r\n\r\n\t\tif (value === 'save') {\r\n\t\t\t__downloadFile.call(self)\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\t//history[0]是画布的初始状态\r\n\t\t//因此只有多于1个历史记录时才可以恢复上一步\r\n\t\tif (value === 'undo' && history.length > 1) {\r\n\t\t\thistory.pop()\r\n\t\t\tcontext.putImageData(history[history.length - 1], 0, 0, 0, 0, rect.width, rect.height)\r\n\t\t}\r\n\r\n\t\t__toggleCanvasCursor.call(self)\r\n\t}\r\n\r\n\t_handles.toggleColor = function(event) {\r\n\t\tconst color = this.getAttribute('data-value')\r\n\t\tstate.strokeColor = color\r\n\t\tutils.each($colorSelected, (index, item) => item.style.background = color)\r\n\t}\r\n\r\n\t_handles.toggleStrokeWidth = function(event) {\r\n\t\tstate.strokeWidth = Number(this.getAttribute('data-value'))\r\n\t\tutils.each($strokeWidth, (index, item) => {\r\n\t\t\tconst value = Number(item.getAttribute('data-value'))\r\n\t\t\tconst method = value === state.strokeWidth ? 'add' : 'remove'\r\n\t\t\tutils.classList(item, method, 'active')\r\n\t\t})\r\n\t}\r\n\r\n\t_handles.toggleFontSize = function(event) {\r\n\t\tstate.fontSize = Number(this.value)\r\n\t}\r\n\r\n\t//鼠标在画布上的初始位置\r\n\tlet _startPos\r\n\r\n\t_handles.onMouseDown = function(event) {\r\n\t\tif (!!~STROKE_TYPES.indexOf(state.drawType) === false || state.drawType === 'font') {\r\n\t\t\treturn\r\n\t\t}\r\n\t\t_startPos = getPos(event, rect)\r\n\r\n\t\t//保存当前快照\r\n\t\tstate.lastImageData = context.getImageData(0, 0, rect.width, rect.height)\r\n\r\n\t\t//初始化context状态\r\n\t\tcontext.lineCap = 'round'\r\n\t\tcontext.lineJoin = 'round'\r\n\t\tcontext.shadowBlur = 0\r\n\t\tcontext.strokeStyle = state.strokeColor\r\n\t\tcontext.lineWidth = state.strokeWidth\r\n\t\tswitch (state.drawType) {\r\n\t\t\tcase 'rect':\r\n\t\t\t\t__drawRect.call(self, event, _startPos)\r\n\t\t\t\tbreak\r\n\t\t\tcase 'ellipse':\r\n\t\t\t\t__drawEllipse.call(self, event, _startPos)\r\n\t\t\t\tbreak\r\n\t\t\tcase 'brush':\r\n\t\t\tdefault:\r\n\t\t\t\t__drawBrush.call(self, event, _startPos)\r\n\t\t\t\tbreak\r\n\t\t}\r\n\r\n\t\tutils.$on(document, 'mousemove', _handles.onMouseMove)\r\n\t\tutils.$on(document, 'mouseup', _handles.onMouseUp)\r\n\t}\r\n\r\n\t_handles.onMouseMove = function(event) {\r\n\t\tif (!!~STROKE_TYPES.indexOf(state.drawType) === false || state.drawType === 'font') {\r\n\t\t\treturn\r\n\t\t}\r\n\t\tswitch (state.drawType) {\r\n\t\t\tcase 'rect':\r\n\t\t\t\t__drawRect.call(self, event, _startPos)\r\n\t\t\t\tbreak\r\n\t\t\tcase 'ellipse':\r\n\t\t\t\t__drawEllipse.call(self, event, _startPos)\r\n\t\t\t\tbreak\r\n\t\t\tcase 'brush':\r\n\t\t\tdefault:\r\n\t\t\t\t__drawBrush.call(self, event, null)\r\n\t\t\t\tbreak\r\n\t\t}\r\n\t}\r\n\r\n\t_handles.onMouseUp = function(event) {\r\n\t\tutils.$off(document, 'mousemove', _handles.onMouseMove)\r\n\t\tutils.$off(document, 'mouseup', _handles.onMouseUp)\r\n\t\tif (!!~STROKE_TYPES.indexOf(state.drawType) && state.drawType !== 'font') {\r\n\t\t\t__pushHistory.call(self)\r\n\t\t}\r\n\t}\r\n\r\n\t_handles.insertTextHelper = function(event) {\r\n\t\tevent.stopPropagation()\r\n\t\tif (state.drawType !== 'font') {\r\n\t\t\treturn\r\n\t\t}\r\n\t\tif (state.isEntry) {\r\n\t\t\t__drawFont.call(self, event)\r\n\t\t\treturn\r\n\t\t}\r\n\t\tinsertTextHelper(event, state, rect)\r\n\t\tstate.isEntry = true\r\n\t}\r\n\r\n\t_handles.removeTextHelper = function(event) {\r\n\t\tif (state.drawType !== 'font') {\r\n\t\t\tremoveTextHelper()\r\n\t\t} else if (!event.target.closest('#canvas-tools-input')) {\r\n\t\t\t__drawFont.call(self, event)\r\n\t\t}\r\n\t}\r\n\r\n\t_handles.resize = function(event) {\r\n\t\tconst _rect = canvas.getBoundingClientRect()\r\n\t\trect.width = canvas.width\r\n\t\trect.height = canvas.height\r\n\t\trect.offsetWidth = canvas.offsetWidth\r\n\t\trect.offsetHeight = canvas.offsetHeight\r\n\t\trect.top = _rect.top\r\n\t\trect.left = _rect.left\r\n\t\tstate.drawType === 'font' && state.isEntry && __drawFont.call(self, event)\r\n\t}\r\n\r\n\t//按钮事件\r\n\tutils.$on($btns, 'click', _handles.btnEmit)\r\n\r\n\t//切换颜色\r\n\tutils.$on($colors, 'click', _handles.toggleColor)\r\n\r\n\t//切换画笔大小\r\n\tutils.$on($strokeWidth, 'click', _handles.toggleStrokeWidth)\r\n\r\n\t//切换字体大小\r\n\tutils.$on($fontSize, 'change', _handles.toggleFontSize)\r\n\r\n\t//矩形，椭圆，画笔等绘制\r\n\tutils.$on(canvas, 'mousedown', _handles.onMouseDown)\r\n\r\n\t//插入文本辅助框\r\n\tutils.$on(canvas, 'click', _handles.insertTextHelper)\r\n\r\n\t//移除文本辅助框\r\n\tutils.$on(document, 'click', _handles.removeTextHelper)\r\n\r\n\t//window resize\r\n\twindow.addEventListener('resize', _handles.resize)\r\n}\r\n\r\n/**\r\n * 绘制矩形\r\n * @param  {MouseEvent} event [鼠标事件]\r\n * @param  {Object} start [起始位置]\r\n * @return \r\n */\r\nfunction __drawRect(event, start) {\r\n\tconst {\r\n\t\tcontext,\r\n\t\trect,\r\n\t\tstate\r\n\t} = this\r\n\tconst pos = getPos(event, rect)\r\n\tlet width = pos.x - start.x\r\n\tlet height = pos.y - start.y\r\n\tcontext.clearRect(0, 0, rect.width, rect.height)\r\n\tcontext.putImageData(state.lastImageData, 0, 0, 0, 0, rect.width, rect.height)\r\n\tcontext.save()\r\n\tcontext.beginPath()\r\n\tcontext.strokeRect(start.x, start.y, width, height)\r\n\tcontext.restore()\r\n\tcontext.closePath()\r\n}\r\n\r\n\r\n/**\r\n * 绘制椭圆\r\n * @param  {MouseEvent} event [鼠标事件]\r\n * @param  {Object} start [起始位置]\r\n * @return \r\n */\r\nfunction __drawEllipse(event, start) {\r\n\tconst {\r\n\t\tcontext,\r\n\t\trect,\r\n\t\tstate\r\n\t} = this\r\n\tconst pos = getPos(event, rect)\r\n\tlet scaleX = 1 * ((pos.x - start.x) / 2)\r\n\tlet scaleY = 1 * ((pos.y - start.y) / 2)\r\n\tlet x = (start.x / scaleX) + 1\r\n\tlet y = (start.y / scaleY) + 1\r\n\tcontext.clearRect(0, 0, rect.width, rect.height)\r\n\tcontext.putImageData(state.lastImageData, 0, 0, 0, 0, rect.width, rect.height)\r\n\tcontext.save()\r\n\tcontext.beginPath()\r\n\tcontext.scale(scaleX, scaleY)\r\n\tcontext.arc(x, y, 1, 0, 2 * Math.PI)\r\n\tcontext.restore()\r\n\tcontext.closePath()\r\n\tcontext.stroke()\r\n}\r\n\r\n/**\r\n * 画笔工具自由绘制\r\n * @param  {MouseEvent} event [鼠标事件]\r\n * @param  {Object | null} start [起始位置]\r\n * @return \r\n */\r\nfunction __drawBrush(event, start = null) {\r\n\tconst {\r\n\t\tcontext,\r\n\t\trect\r\n\t} = this\r\n\tif (start) {\r\n\t\tcontext.beginPath()\r\n\t\tcontext.moveTo(start.x, start.y)\r\n\t} else {\r\n\t\tconst pos = getPos(event, rect)\r\n\t\tcontext.lineTo(pos.x, pos.y)\r\n\t\tcontext.stroke()\r\n\t}\r\n}\r\n\r\n\r\n/**\r\n * 绘制文字\r\n * @param  {MouseEvent} event [鼠标事件]\r\n * @return {[type]} \r\n */\r\nfunction __drawFont(event) {\r\n\tconst $textHelper = document.getElementById(TEXT_HELPER_ID)\r\n\tif (!$textHelper) {\r\n\t\tthis.state.isEntry = false\r\n\t\treturn\r\n\t}\r\n\tconst content = $textHelper.textContent.trim()\r\n\tconst length = content.length\r\n\tif (!content || !length) {\r\n\t\tthis.state.isEntry = false\r\n\t\tremoveTextHelper()\r\n\t\treturn\r\n\t}\r\n\tconst style = utils.getComputedStyles($textHelper),\r\n\t\tthreshold = this.state.fontSize || TEXT_HELPER_FONT_SIZE,\r\n\t\tpadding = 2 * TEXT_HELPER_PADDING,\r\n\t\tcontext = this.context\r\n\r\n\tlet x = parseFloat(style.left) - this.rect.left + padding - 2,\r\n\t\ty = parseFloat(style.top) - this.rect.top + threshold,\r\n\t\tlineWidth = 0,\r\n\t\tlastSubStrIndex = 0\r\n\r\n\tcontext.beginPath()\r\n\tcontext.save()\r\n\tcontext.fillStyle = this.state.strokeColor\r\n\tcontext.font = `${this.state.fontSize}px ${TEXT_FONT_FAMILY}`\r\n\r\n\tfor (let i = 0; i < length; i++) {\r\n\t\tlet char = content[i]\r\n\r\n\t\t//让文字自动换行\r\n\t\tlineWidth += context.measureText(char).width\r\n\t\tif (lineWidth > this.rect.width - x) {\r\n\t\t\tcontext.fillText(content.substring(lastSubStrIndex, i), x, y)\r\n\t\t\ty += threshold\r\n\t\t\tlineWidth = 0\r\n\t\t\tlastSubStrIndex = i\r\n\t\t}\r\n\t\tif (i == length - 1) {\r\n\t\t\tcontext.fillText(content.substring(lastSubStrIndex, i + 1), x, y);\r\n\t\t}\r\n\t}\r\n\tcontext.restore()\r\n\tcontext.closePath()\r\n\tthis.state.isEntry = false\r\n\tremoveTextHelper()\r\n\t__pushHistory.call(this)\r\n}\r\n\r\n\r\n/**\r\n * 切换鼠标指针\r\n * @return \r\n */\r\nfunction __toggleCanvasCursor() {\r\n\tconst canvas = this.canvas\r\n\tlet cursor\r\n\tswitch (this.state.drawType) {\r\n\t\tcase 'brush':\r\n\t\t\tcursor = 'brush'\r\n\t\t\tbreak\r\n\t\tcase 'font':\r\n\t\t\tcursor = 'font'\r\n\t\t\tbreak\r\n\t\tcase 'rect':\r\n\t\tcase 'ellipse':\r\n\t\t\tcursor = 'crosshair'\r\n\t\t\tbreak\r\n\t\tdefault:\r\n\t\t\tcursor = 'default'\r\n\t}\r\n\tif (cursor) {\r\n\t\tcanvas.className = canvas.className.replace(/canvas-cursor__(\\w+)/, '').trim() + ` canvas-cursor__${cursor}`\r\n\t}\r\n}\r\n\r\n\r\n/**\r\n * 保存到历史记录\r\n * @return  \r\n */\r\nfunction __pushHistory() {\r\n\tthis.history.push(this.context.getImageData(0, 0, this.rect.width, this.rect.height))\r\n}\r\n\r\n/**\r\n * CanvasTools\r\n * Class\r\n */\r\nclass CanvasTools {\r\n\r\n\t/**\r\n\t * constructor\r\n\t * @param  {CanvasElement} canvas  [canvas element object]\r\n\t * @param  {Object} options [config]\r\n\t * @return {Object}         [instance]\r\n\t */\r\n\tconstructor(canvas, options) {\r\n\t\tif (!canvas || typeof canvas.getContext !== 'function') {\r\n\t\t\tthrow new Error('invalid canvas object')\r\n\t\t}\r\n\t\tthis.canvas = canvas\r\n\t\tthis.context = canvas.getContext('2d')\r\n\t\tthis.config = utils.extend({}, defaults, options || {})\r\n\r\n\t\tthis.history = []\r\n\t\tthis.state = Object.create(null)\r\n\t\tthis.rect = Object.create(null)\r\n\t\tthis._handles = Object.create(null)\r\n\r\n\t\tthis.state.strokeWidth = STROKE_DEFAULT_WIDTH\r\n\t\tthis.state.fontSize = TEXT_HELPER_FONT_SIZE\r\n\t\tthis.state.strokeColor = STROKE_DEFAULT_COLOR\r\n\t\tthis.state.drawType = 'brush'\r\n\t\tthis.state.isEntry = false\r\n\r\n\t\tthis.rect.width = canvas.width\r\n\t\tthis.rect.height = canvas.height\r\n\r\n\t\tthis.rect.offsetWidth = canvas.offsetWidth\r\n\t\tthis.rect.offsetHeight = canvas.offsetHeight\r\n\r\n\t\tconst rect = canvas.getBoundingClientRect()\r\n\t\tthis.rect.top = rect.top\r\n\t\tthis.rect.left = rect.left\r\n\r\n\t\t//保存现场\r\n\t\tthis.state.lastImageData = this.context.getImageData(0, 0, this.rect.width, this.rect.height)\r\n\r\n\t\t//将画布的初始状态保存到历史记录\r\n\t\t__pushHistory.call(this)\r\n\r\n\t\t__toggleCanvasCursor.call(this)\r\n\r\n\t\tthis.render()\r\n\t}\r\n\r\n\t/**\r\n\t * 初始化工具条到DOM\r\n\t * @return\r\n\t */\r\n\trender() {\r\n\t\tconst C = this.config\r\n\t\tconst S = this.state\r\n\t\tlet el = document.createElement('div')\r\n\t\tel.className = 'canvas-tools'\r\n\t\tel.innerHTML = Template.getButtons(C.buttons)\r\n\t\tC.container.appendChild(el)\r\n\r\n\t\tthis.$el = el\r\n\t\tthis.$el.appendChild(buildStrokePanel(S.strokeWidth, S.strokeColor))\r\n\t\tthis.$el.appendChild(buildFontPanel(S.fontSize, S.strokeColor))\r\n\t\t__bindEvents.call(this)\r\n\t}\r\n\r\n\trefresh() {\r\n\r\n\t}\r\n\r\n\t/**\r\n\t * destory\r\n\t * @return \r\n\t */\r\n\tdestory() {\r\n\t\tconst {\r\n\t\t\tcanvas,\r\n\t\t\t$el,\r\n\t\t\t_handles\r\n\t\t} = this\r\n\r\n\t\tconst $btns = utils.$('.js-btn', $el),\r\n\t\t\t$colors = utils.$('.js-color', $el),\r\n\t\t\t$strokeWidth = utils.$('.js-stroke-width', $el),\r\n\t\t\t$fontSize = utils.$('.js-font-size', $el),\r\n\t\t\t$textHelper = document.getElementById(TEXT_HELPER_ID)\r\n\r\n\t\tutils.$off($btns, 'click', _handles.btnEmit)\r\n\t\tutils.$off($colors, 'click', _handles.toggleColor)\r\n\t\tutils.$off($strokeWidth, 'click', _handles.toggleStrokeWidth)\r\n\t\tutils.$off($fontSize, 'change', _handles.toggleFontSize)\r\n\t\tutils.$off(canvas, 'mousedown', _handles.onMouseDown)\r\n\t\tutils.$off(canvas, 'click', _handles.insertTextHelper)\r\n\t\tutils.$off(document, 'click', _handles.removeTextHelper)\r\n\t\twindow.removeEventListener('resize', _handles.resize)\r\n\t\t$textHelper && $textHelper.parentNoed.removeChild($textHelper)\r\n\t\tthis.canvas = null\r\n\t\tthis.context = null\r\n\t\tthis.history.length = 0\r\n\t\tthis.config.container.removeChild(this.$el)\r\n\t}\r\n\r\n}\r\n\r\nexport default CanvasTools\n\n\n// WEBPACK FOOTER //\n// ./src/js/main.js"],"sourceRoot":""}